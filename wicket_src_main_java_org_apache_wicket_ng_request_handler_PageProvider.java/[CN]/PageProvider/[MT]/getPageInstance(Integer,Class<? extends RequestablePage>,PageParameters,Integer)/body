{
  RequestablePage page=null;
  boolean freshCreated=false;
  if (pageId != null) {
    page=getPageSource().getPageInstance(pageId);
    if (page != null && pageClass != null && page.getClass().equals(pageClass) == false) {
      page=null;
    }
 else     if (page != null && pageParameters != null) {
      page.getPageParameters().assign(pageParameters);
    }
  }
  if (page == null) {
    if (pageClass != null) {
      page=getPageSource().newPageInstance(pageClass,pageParameters);
      freshCreated=true;
      if (prepareForRenderNewPage() && page instanceof Page) {
        ((Page)page).prepareForRender(false);
      }
    }
  }
  if (page != null && !freshCreated) {
    if (renderCount != null && page.getRenderCount() != renderCount) {
      throw new StalePageException(page);
    }
  }
  return page;
}
