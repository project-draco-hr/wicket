{
  try {
    CharSequence url=null;
    if (requestTarget != null) {
      url=requestCycle.urlFor(requestTarget);
      if (url == null) {
        requestTarget.respond(requestCycle);
        return;
      }
    }
    final Application app=Application.get();
    final boolean oldUseCheck=app.getDebugSettings().getComponentUseCheck();
    app.getDebugSettings().setComponentUseCheck(false);
    final String encoding=app.getRequestCycleSettings().getResponseRequestEncoding();
    WebResponse response=(WebResponse)requestCycle.getResponse();
    response.setCharacterEncoding(encoding);
    response.setContentType("text/xml; charset=" + encoding);
    response.setHeader("Expires","Mon, 26 Jul 1997 05:00:00 GMT");
    response.setHeader("Cache-Control","no-cache, must-revalidate");
    response.setHeader("Pragma","no-cache");
    response.write("<?xml version=\"1.0\" encoding=\"");
    response.write(encoding);
    response.write("\"?>");
    response.write("<ajax-response>");
    if (url == null) {
      Iterator it=prependJavascripts.iterator();
      while (it.hasNext()) {
        String js=(String)it.next();
        respondInvocation(response,js);
      }
      it=markupIdToComponent.entrySet().iterator();
      while (it.hasNext()) {
        final Map.Entry entry=(Entry)it.next();
        final Component component=(Component)entry.getValue();
        final String markupId=(String)entry.getKey();
        respondHeaderContribution(response,component);
        respondComponent(response,markupId,component);
      }
      it=appendJavascripts.iterator();
      while (it.hasNext()) {
        String js=(String)it.next();
        respondInvocation(response,js);
      }
    }
 else {
      if (requestTarget instanceof IPageRequestTarget) {
        Session.get().touch(((IPageRequestTarget)requestTarget).getPage());
      }
      respondInvocation(response,"window.location='" + url + "';");
    }
    response.write("</ajax-response>");
    app.getDebugSettings().setComponentUseCheck(oldUseCheck);
  }
 catch (  RuntimeException ex) {
    LOG.error("Error while responding to an AJAX request: " + toString(),ex);
  }
}
