{
  try {
    final Application app=Application.get();
    final boolean oldUseCheck=app.getDebugSettings().getComponentUseCheck();
    app.getDebugSettings().setComponentUseCheck(false);
    final String encoding=app.getRequestCycleSettings().getResponseRequestEncoding();
    WebResponse response=(WebResponse)requestCycle.getResponse();
    response.setCharacterEncoding(encoding);
    response.setContentType("text/xml; charset=" + encoding);
    response.setHeader("Expires","Mon, 26 Jul 1997 05:00:00 GMT");
    response.setHeader("Cache-Control","no-cache, must-revalidate");
    response.setHeader("Pragma","no-cache");
    response.write("<?xml version=\"1.0\" encoding=\"");
    response.write(encoding);
    response.write("\"?>");
    response.write("<ajax-response>");
    Iterator it=markupIdToComponent.entrySet().iterator();
    while (it.hasNext()) {
      final Map.Entry entry=(Entry)it.next();
      final Component component=(Component)entry.getValue();
      final String markupId=(String)entry.getKey();
      respondComponent(response,markupId,component);
    }
    it=javascripts.iterator();
    while (it.hasNext()) {
      String js=(String)it.next();
      respondInvocation(response,js);
    }
    response.write("</ajax-response>");
    app.getDebugSettings().setComponentUseCheck(oldUseCheck);
  }
 catch (  RuntimeException ex) {
    LOG.error("Error while responding to an AJAX request: " + toString(),ex);
  }
}
