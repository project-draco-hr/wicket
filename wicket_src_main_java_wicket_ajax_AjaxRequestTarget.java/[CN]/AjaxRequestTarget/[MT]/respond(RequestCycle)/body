{
  final WebResponse response=(WebResponse)requestCycle.getResponse();
  try {
    final Application app=Application.get();
    final String encoding=app.getRequestCycleSettings().getResponseRequestEncoding();
    response.setCharacterEncoding(encoding);
    response.setContentType("text/xml; charset=" + encoding);
    response.setHeader("Expires","Mon, 26 Jul 1997 05:00:00 GMT");
    response.setHeader("Cache-Control","no-cache, must-revalidate");
    response.setHeader("Pragma","no-cache");
    response.write("<?xml version=\"1.0\" encoding=\"");
    response.write(encoding);
    response.write("\"?>");
    response.write("<ajax-response>");
    for (    String js : prependJavascripts) {
      respondInvocation(response,js);
    }
    for (    Map.Entry<String,Component> entry : markupIdToComponent.entrySet()) {
      final Component component=entry.getValue();
      final String markupId=entry.getKey();
      respondComponent(response,markupId,component);
    }
    for (    String js : appendJavascripts) {
      respondInvocation(response,js);
    }
    response.write("</ajax-response>");
  }
 catch (  RuntimeException ex) {
    Log.error("Error while responding to an AJAX request: " + toString(),ex);
  }
 finally {
    requestCycle.setResponse(response);
  }
}
