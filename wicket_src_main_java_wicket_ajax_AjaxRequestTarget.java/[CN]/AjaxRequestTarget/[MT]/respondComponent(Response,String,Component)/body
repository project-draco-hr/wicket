{
  if (component.getRenderBodyOnly() == true) {
    throw new IllegalStateException("Ajax render cannot be called on component that has setRenderBodyOnly enabled. Component: " + component.toString());
  }
  component.setOutputMarkupId(true);
  final Page page=component.getPage();
  if (page == null) {
    throw new IllegalStateException("Ajax request attempted on a component that is not associated with a Page");
  }
  final boolean versioned=page.isVersioned();
  page.setVersioned(false);
  page.startComponentRender(component);
  respondHeaderContribution(response,component);
  Response componentResponse=new StringResponse();
  try {
    RequestCycle.get().setResponse(componentResponse);
    component.renderComponent();
  }
  finally {
    RequestCycle.get().setResponse(response);
  }
  page.endComponentRender(component);
  page.setVersioned(versioned);
  response.write("<component id=\"");
  response.write(markupId);
  response.write("\" ");
  String data=componentResponse.toString();
  if (needsEncoding(componentResponse.toString())) {
    response.write(" encoding=\"");
    response.write(getEncodingName());
    response.write("\" ");
    data=encode(data);
  }
  response.write("><![CDATA[");
  response.write(data);
  response.write("]]></component>");
}
