{
  final javax.servlet.http.HttpSession httpServletSession=request.getSession(true);
  final String sessionAttributeName="session" + request.getServletPath();
  HttpSession httpSession=(HttpSession)httpServletSession.getAttribute(sessionAttributeName);
  if (httpSession == null) {
    final Session session=application.getSessionFactory().newSession();
    if (session instanceof HttpSession) {
      httpSession=(HttpSession)session;
    }
 else {
      throw new WicketRuntimeException("Session created by a WebApplication session factory must be a subclass of HttpSession");
    }
    httpSession.httpServletSession=httpServletSession;
    httpSession.setLocale(request.getLocale());
    httpServletSession.setAttribute(sessionAttributeName,httpSession);
  }
 else {
    httpSession.httpServletSession=httpServletSession;
  }
  Session.set(httpSession);
  return httpSession;
}
