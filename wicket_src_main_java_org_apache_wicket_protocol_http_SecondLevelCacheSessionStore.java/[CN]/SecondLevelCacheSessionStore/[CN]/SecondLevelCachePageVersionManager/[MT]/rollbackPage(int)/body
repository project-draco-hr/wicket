{
  String sessionId=page.getSession().getId();
  if (sessionId != null) {
    int versionNumber=currentVersionNumber;
    int ajaxNumber=currentAjaxVersionNumber;
    if (versionStarted) {
      versionNumber--;
      ajaxNumber--;
    }
    IPageStore store=((SecondLevelCacheSessionStore)Application.get().getSessionStore()).getStore();
    if (ajaxNumber >= numberOfVersions) {
      return store.getPage(sessionId,page.getPageMapName(),page.getNumericId(),versionNumber,ajaxNumber - numberOfVersions);
    }
 else {
      versionNumber--;
      ajaxNumber=lastAjaxVersionNumber - (numberOfVersions - ajaxNumber);
      if (ajaxNumber < 0) {
        log.error("trying to rollback to many versions, jumping over 2 page versions is not supported yet.");
        return null;
      }
      return store.getPage(sessionId,page.getPageMapName(),page.getNumericId(),versionNumber,ajaxNumber);
    }
  }
  return null;
}
