{
  if (!applicationResolved) {
    application=getApplication();
    applicationResolved=true;
  }
  if (application != null && System.getProperty(METRICS_STATIC_REGISTRATION) == null) {
    MetricRegistry metricRegistry=application.getMetaData(METRIC_REGISTRY);
    if (metricRegistry == null) {
      metricRegistry=new MetricRegistry();
      application.setMetaData(METRIC_REGISTRY,metricRegistry);
    }
    return metricRegistry;
  }
 else {
    if (WicketMetrics.metricRegistry == null) {
      WicketMetrics.metricRegistry=new MetricRegistry();
    }
    return WicketMetrics.metricRegistry;
  }
}
