{
  if (parameters != null && parameters.size() > 0) {
    final Iterator entries;
    if (UnitTestSettings.getSortUrlParameters()) {
      entries=new TreeMap(parameters).entrySet().iterator();
    }
 else {
      entries=parameters.entrySet().iterator();
    }
    while (entries.hasNext()) {
      Map.Entry entry=(Entry)entries.next();
      Object value=entry.getValue();
      if (value != null) {
        if (value instanceof String[]) {
          String[] values=(String[])value;
          for (int i=0; i < values.length; i++) {
            String escapedValue=urlEncode(values[i]);
            if (!Strings.isEmpty(escapedValue)) {
              url.append("/").append(entry.getKey()).append("/").append(escapedValue);
            }
          }
        }
 else {
          String escapedValue=urlEncode(value.toString());
          if (!Strings.isEmpty(escapedValue)) {
            url.append("/").append(entry.getKey()).append("/").append(escapedValue);
          }
        }
      }
    }
  }
}
