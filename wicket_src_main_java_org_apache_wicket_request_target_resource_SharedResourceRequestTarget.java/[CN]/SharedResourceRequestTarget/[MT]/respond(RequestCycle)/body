{
  Application application=requestCycle.getApplication();
  SharedResources sharedResources=application.getSharedResources();
  final String resourceKey=getRequestParameters().getResourceKey();
  Resource resource=sharedResources.get(resourceKey);
  if (resource == null) {
    int ix=resourceKey.indexOf('/');
    if (ix != -1) {
      String className=resourceKey.substring(0,ix);
      IClassResolver resolver=application.getApplicationSettings().getClassResolver();
      Class<?> scope=null;
      try {
        scope=Application.get().getSharedResources().getAliasClass(className);
        if (scope == null) {
          scope=resolver.resolveClass(className);
        }
        final CharSequence escapeString=application.getResourceSettings().getParentFolderPlaceholder();
        String path=resourceKey.substring(ix + 1).replace(escapeString,"..");
        if (PackageResource.exists(scope,path,null,null)) {
          PackageResource packageResource=PackageResource.get(scope,path);
          if (sharedResources.get(resourceKey) == null) {
            sharedResources.add(scope,path,null,null,packageResource);
          }
          resource=packageResource;
        }
      }
 catch (      Exception e) {
        log.error("unable to lazily register shared resource " + resourceKey,e);
      }
    }
  }
  if (resource == null) {
    Response response=requestCycle.getResponse();
    if (response instanceof WebResponse) {
      ((WebResponse)response).getHttpServletResponse().setStatus(HttpServletResponse.SC_NOT_FOUND);
      log.error("shared resource " + resourceKey + " not found");
      return;
    }
 else {
      throw new WicketRuntimeException("shared resource " + resourceKey + " not found");
    }
  }
  if (requestParameters != null) {
    resource.setParameters(requestParameters.getParameters());
  }
  resource.onResourceRequested();
}
