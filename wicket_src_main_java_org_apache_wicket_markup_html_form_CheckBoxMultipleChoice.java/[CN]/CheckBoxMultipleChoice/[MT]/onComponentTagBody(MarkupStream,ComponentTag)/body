{
  final List<? extends T> choices=getChoices();
  final AppendingStringBuffer buffer=new AppendingStringBuffer(70 * (choices.size() + 1));
  final String selected=getValue();
  for (int index=0; index < choices.size(); index++) {
    final T choice=choices.get(index);
    Collection<T> displayValue=(Collection<T>)getChoiceRenderer().getDisplayValue(choice);
    Class<?> objectClass=(displayValue == null ? null : displayValue.getClass());
    String label="";
    if (objectClass != null && objectClass != String.class) {
      final IConverter<Collection<T>> converter=getConverter((Class<Collection<T>>)objectClass);
      if (!converter.getClass().isAssignableFrom(objectClass))       throw new IllegalArgumentException("converter can not convert class " + converter.getClass().getName() + " to string");
      label=converter.convertToString(displayValue,getLocale());
    }
 else     if (displayValue != null) {
      label=displayValue.toString();
    }
    if (label != null) {
      buffer.append(getPrefix());
      String id=getChoiceRenderer().getIdValue(choice,index);
      final String idAttr=getInputName() + "_" + id;
      buffer.append("<input name=\"").append(getInputName()).append("\"").append(" type=\"checkbox\"").append((isSelected(choice,index,selected) ? " checked=\"checked\"" : "")).append((isEnabled() ? "" : " disabled=\"disabled\"")).append(" value=\"").append(id).append("\" id=\"").append(idAttr).append("\"/>");
      String display=label;
      if (localizeDisplayValues()) {
        display=getLocalizer().getString(label,this,label);
      }
      CharSequence escaped;
      if (isEscapeLabelMarkup()) {
        escaped=Strings.escapeMarkup(display,false,true);
      }
 else {
        escaped=display;
      }
      buffer.append("<label for=\"");
      buffer.append(idAttr);
      buffer.append("\">").append(escaped).append("</label>");
      buffer.append(getSuffix());
    }
  }
  replaceComponentTagBody(markupStream,openTag,buffer);
}
