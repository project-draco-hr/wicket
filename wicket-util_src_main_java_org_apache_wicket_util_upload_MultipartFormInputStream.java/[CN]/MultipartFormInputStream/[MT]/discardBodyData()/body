{
  boolean done=false;
  int pad;
  int pos;
  int bytesRead;
  int total=0;
  while (!done) {
    pos=findSeparator();
    if (pos != -1) {
      total+=pos - head;
      head=pos;
      done=true;
    }
 else {
      if (tail - head > keepRegion) {
        pad=keepRegion;
      }
 else {
        pad=tail - head;
      }
      total+=tail - head - pad;
      System.arraycopy(buffer,tail - pad,buffer,0,pad);
      head=0;
      bytesRead=input.read(buffer,pad,bufSize - pad);
      if (bytesRead != -1) {
        tail=pad + bytesRead;
      }
 else {
        total+=pad;
        throw new MalformedStreamException("Stream ended unexpectedly");
      }
    }
  }
  return total;
}
