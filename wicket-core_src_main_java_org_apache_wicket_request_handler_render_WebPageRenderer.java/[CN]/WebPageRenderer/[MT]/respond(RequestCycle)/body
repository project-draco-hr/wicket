{
  Url currentUrl=requestCycle.getUrlRenderer().getBaseUrl();
  Url targetUrl=requestCycle.mapUrlFor(getRenderPageRequestHandler());
  BufferedWebResponse bufferedResponse=getAndRemoveBufferedResponse(currentUrl);
  boolean isAjax=isAjax(requestCycle);
  boolean shouldPreserveClientUrl=((WebRequest)requestCycle.getRequest()).shouldPreserveClientUrl();
  if (bufferedResponse != null) {
    logger.warn("The Buffered response should be handled by BufferedResponseRequestHandler");
    bufferedResponse.writeTo((WebResponse)requestCycle.getResponse());
  }
 else   if (getRedirectPolicy() == RedirectPolicy.NEVER_REDIRECT || isOnePassRender() || (!isAjax && (targetUrl.equals(currentUrl) && !getPageProvider().isNewPageInstance() && !getPage().isPageStateless()) || (targetUrl.equals(currentUrl) && isRedirectToRender())) || shouldPreserveClientUrl) {
    BufferedWebResponse response=renderPage(currentUrl,requestCycle);
    if (response != null) {
      response.writeTo((WebResponse)requestCycle.getResponse());
    }
  }
 else   if ((!targetUrl.equals(currentUrl) && getRedirectPolicy() == RedirectPolicy.ALWAYS_REDIRECT) || isRedirectToRender() || (isAjax && targetUrl.equals(currentUrl))) {
    redirectTo(targetUrl,requestCycle);
  }
 else   if (!targetUrl.equals(currentUrl) && (getPageProvider().isNewPageInstance() || (isSessionTemporary() && getPage().isPageStateless()))) {
    redirectTo(targetUrl,requestCycle);
  }
 else   if (isRedirectToBuffer()) {
    BufferedWebResponse response=renderPage(targetUrl,requestCycle);
    if (response == null) {
      return;
    }
    Url targetUrl2=requestCycle.mapUrlFor(getRenderPageRequestHandler());
    if (targetUrl.getSegments().equals(targetUrl2.getSegments()) == false) {
      response=renderPage(targetUrl2,requestCycle);
    }
    if (getPage().isPageStateless() && !enableRedirectForStatelessPage()) {
      response.writeTo((WebResponse)requestCycle.getResponse());
    }
 else {
      storeBufferedResponse(targetUrl2,response);
      redirectTo(targetUrl2,requestCycle);
    }
  }
 else {
    throw new IllegalStateException("Unknown RenderStrategy.");
  }
}
