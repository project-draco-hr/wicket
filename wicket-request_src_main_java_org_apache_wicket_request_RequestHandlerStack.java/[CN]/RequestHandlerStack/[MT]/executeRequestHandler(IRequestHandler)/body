{
  final boolean first=requestHandlers.isEmpty();
  requestHandlers.add(handler);
  IRequestHandler replacementHandler=null;
  Response originalResponse=response;
  try {
    handler.respond(getRequestCycle());
  }
 catch (  RuntimeException exception) {
    ReplaceHandlerException replacer=Exceptions.findCause(exception,ReplaceHandlerException.class);
    if (replacer == null) {
      throw exception;
    }
    if (replacer.removeAll && !first) {
      throw (RuntimeException)exception;
    }
    replacementHandler=replacer.replacementRequestHandler;
  }
 finally {
    response=originalResponse;
    requestHandlers.poll();
    inactiveRequestHandlers.add(handler);
  }
  IRequestHandler scheduled=scheduledAfterCurrent;
  scheduledAfterCurrent=null;
  if (replacementHandler != null) {
    executeRequestHandler(replacementHandler);
  }
 else   if (scheduled != null) {
    executeRequestHandler(scheduled);
  }
}
