{
  if (relativePathPrefixToWicketHandler != null) {
    return relativePathPrefixToWicketHandler;
  }
  String relativeUrl=getPath();
  PrependingStringBuffer prepender=new PrependingStringBuffer();
  HttpServletRequest httpRequest=getHttpServletRequest();
  String errorUrl=(String)httpRequest.getAttribute("javax.servlet.error.request_uri");
  String forwardUrl=(String)httpRequest.getAttribute("javax.servlet.forward.servlet_path");
  if (errorUrl != null) {
    errorUrl=errorUrl.substring(httpRequest.getContextPath().length());
    String servletPath=httpRequest.getServletPath();
    if (!errorUrl.startsWith(servletPath)) {
      prepender.prepend(servletPath.substring(1) + "/");
    }
    for (int i=servletPath.length() + 1; i < errorUrl.length(); i++) {
      if (errorUrl.charAt(i) == '?') {
        break;
      }
      if (errorUrl.charAt(i) == '/') {
        prepender.prepend("../");
      }
    }
    return prepender.toString();
  }
  if (forwardUrl != null) {
    relativeUrl=forwardUrl.substring(relativeUrl.length() > 0 ? 1 : 0);
  }
  if (depthRelativeToWicketHandler == -1) {
    int depth=0;
    for (int i=0; i < relativeUrl.length(); i++) {
      if (relativeUrl.charAt(i) == '?') {
        break;
      }
      if (relativeUrl.charAt(i) == '/') {
        depth++;
      }
    }
    depthRelativeToWicketHandler=depth;
  }
  for (int i=0; i < depthRelativeToWicketHandler; i++) {
    prepender.prepend("../");
  }
  return relativePathPrefixToWicketHandler=prepender.toString();
}
