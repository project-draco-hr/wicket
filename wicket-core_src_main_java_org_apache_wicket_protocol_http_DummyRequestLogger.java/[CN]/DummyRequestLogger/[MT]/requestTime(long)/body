{
  RequestData rd=RequestCycle.get().getMetaData(REQUEST_DATA);
  if (rd != null) {
    if (activeRequests.get() > 0) {
      rd.setActiveRequest(activeRequests.decrementAndGet());
    }
    Session session=Session.get();
    String sessionId=session.getId();
    rd.setSessionId(sessionId);
    Object sessionInfo=getSessionInfo(session);
    rd.setSessionInfo(sessionInfo);
    long sizeInBytes=-1;
    if (Application.get().getRequestLoggerSettings().getRecordSessionSize()) {
      try {
        sizeInBytes=session.getSizeInBytes();
      }
 catch (      Exception e) {
        log.error("Exception while determining the size of the session in the request logger: " + e.getMessage(),e);
      }
    }
    rd.setSessionSize(sizeInBytes);
    rd.setTimeTaken(timeTaken);
    requests.add(0,rd);
    if (sessionId != null) {
      SessionData sd=liveSessions.get(sessionId);
      if (sd == null) {
        sessionCreated(sessionId);
        sd=liveSessions.get(sessionId);
      }
      if (sd != null) {
        sd.setSessionInfo(sessionInfo);
        sd.setSessionSize(sizeInBytes);
        sd.addTimeTaken(timeTaken);
        log(rd,sd);
      }
 else {
        log(rd,null);
      }
    }
 else {
      log(rd,null);
    }
  }
}
