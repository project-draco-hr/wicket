{
  if (dirty) {
    if (log.isDebugEnabled()) {
      log.debug("update: Session is dirty.  Replicating.");
    }
    this.dirty=false;
    setAttribute(SESSION_ATTRIBUTE_NAME,this);
  }
 else {
    if (log.isDebugEnabled()) {
      log.debug("update: Session not dirty.");
    }
  }
  List dirtyObjects=(List)Session.dirtyObjects.get();
  if (dirtyObjects != null) {
    for (final Iterator iterator=dirtyObjects.iterator(); iterator.hasNext(); ) {
      String attribute=null;
      Object object=iterator.next();
      if (object instanceof Page) {
        final Page page=(Page)object;
        attribute=page.getPageMap().attributeForId(page.getNumericId());
        object=page.getPageMapEntry();
      }
 else       if (object instanceof PageMap) {
        attribute=attributeForPageMapName(((PageMap)object).getName());
      }
      Object previous=getAttribute(attribute);
      if (previous != null) {
        setAttribute(attribute,object);
      }
    }
    Session.dirtyObjects.set(null);
  }
}
