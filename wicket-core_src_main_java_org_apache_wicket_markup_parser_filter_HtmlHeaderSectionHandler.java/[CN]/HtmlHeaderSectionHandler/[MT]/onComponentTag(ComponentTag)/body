{
  if (ignoreTheRest == true) {
    return tag;
  }
  if (HEAD.equalsIgnoreCase(tag.getName())) {
    if (tag.getNamespace() == null) {
      if (tag.isOpen()) {
        foundHead=true;
        if (tag.getId() == null) {
          tag.setId(HEADER_ID);
          tag.setAutoComponentTag(true);
          tag.setModified(true);
        }
      }
 else       if (tag.isClose()) {
        if (foundHeaderItemsTag) {
          ComponentTag headOpenTag=tag.getOpenTag();
          headOpenTag.setId(HEADER_ID + "-Ignored");
          headOpenTag.setAutoComponentTag(false);
          headOpenTag.setModified(false);
          headOpenTag.setFlag(ComponentTag.RENDER_RAW,true);
        }
        foundClosingHead=true;
      }
      return tag;
    }
 else {
      foundHead=true;
      foundClosingHead=true;
    }
  }
 else   if (HtmlHeaderResolver.HEADER_ITEMS.equalsIgnoreCase(tag.getName()) && tag.getNamespace().equalsIgnoreCase(getWicketNamespace())) {
    if (foundHeaderItemsTag) {
      throw new MarkupException(new MarkupStream(markup),"More than one <wicket:header-items/> detected in the <head> element. Only one is allowed.");
    }
 else     if (foundClosingHead) {
      throw new MarkupException(new MarkupStream(markup),"Detected <wicket:header-items/> after the closing </head> element.");
    }
    foundHeaderItemsTag=true;
    tag.setId(HEADER_ID);
    tag.setAutoComponentTag(true);
    tag.setModified(true);
    return tag;
  }
 else   if (BODY.equalsIgnoreCase(tag.getName()) && (tag.getNamespace() == null)) {
    if (foundHead && !foundClosingHead) {
      throw new MarkupException(new MarkupStream(markup),"Invalid page markup. Tag <BODY> found inside <HEAD>");
    }
    if (foundHead == false) {
      insertHeadTag();
    }
    ignoreTheRest=true;
    return tag;
  }
  return tag;
}
