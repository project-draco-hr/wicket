{
  if (cacheKey == null) {
    throw new IllegalArgumentException("Parameter 'cacheKey' must not be null");
  }
  if (log.isDebugEnabled()) {
    log.debug("Remove from cache: cacheKey=" + cacheKey);
  }
  String locationString=(String)markupKeyCache.get(cacheKey);
  Markup markup=markupCache.get(locationString);
  if (markup != null) {
    markupCache.remove(locationString);
    int count;
    do {
      count=0;
      Iterator<CharSequence> iter=markupCache.getKeys().iterator();
      while (iter.hasNext()) {
        Markup cacheMarkup=markupCache.get(iter.next());
        MarkupResourceData resourceData=cacheMarkup.getMarkupResourceData().getBaseMarkupResourceData();
        if (resourceData != null) {
          String baseCacheKey=resourceData.getResource().getCacheKey();
          String baseLocationString=(String)markupKeyCache.get(baseCacheKey);
          if (baseLocationString != null && markupCache.get(baseLocationString) == null) {
            if (log.isDebugEnabled()) {
              log.debug("Remove from cache: cacheKey=" + cacheMarkup.getMarkupResourceData().getResource().getCacheKey());
            }
            iter.remove();
            count++;
          }
        }
      }
    }
 while (count > 0);
    final ModificationWatcher watcher=application.getResourceSettings().getResourceWatcher(true);
    if (watcher != null) {
      Iterator<IModifiable> iter=watcher.getEntries().iterator();
      while (iter.hasNext()) {
        IModifiable modifiable=iter.next();
        if (modifiable instanceof MarkupResourceStream) {
          MarkupResourceStream resourceStream=(MarkupResourceStream)modifiable;
          String resourceCacheKey=resourceStream.getCacheKey();
          String resouceLocationString=(String)markupKeyCache.get(resourceCacheKey);
          if (resouceLocationString != null && markupCache.containsKey(resouceLocationString) == false) {
            iter.remove();
          }
        }
      }
    }
  }
  return markup;
}
