{
  final Localizer localizer=getLocalizer();
  if (getLocalizer() == null) {
    if (component != null) {
      setLocalizer(component.getLocalizer());
    }
 else {
      throw new IllegalStateException("No localizer has been set");
    }
  }
  if (locale == null) {
    locale=Session.get().getLocale();
  }
  String value;
  Object[] parameters=getParameters();
  if (parameters == null || parameters.length == 0) {
    value=localizer.getString(getResourceKey(),component,model,defaultValue);
    if (value == null) {
      value=defaultValue;
    }
  }
 else {
    value=localizer.getString(getResourceKey(),component,null,defaultValue);
    if (value == null) {
      value=defaultValue;
    }
    if (value != null) {
      Object[] realParams=new Object[parameters.length];
      for (int i=0; i < parameters.length; i++) {
        if (parameters[i] instanceof IModel) {
          realParams[i]=((IModel<?>)parameters[i]).getObject();
        }
 else         if (model != null && parameters[i] instanceof String) {
          realParams[i]=PropertyVariableInterpolator.interpolate((String)parameters[i],model.getObject());
        }
 else {
          realParams[i]=parameters[i];
        }
      }
      if (value.indexOf('\'') != -1) {
        value=escapeQuotes(value);
      }
      if (model != null) {
        value=Strings.replaceAll(value,"${","$'{'").toString();
      }
      final MessageFormat format=new MessageFormat(value,component != null ? component.getLocale() : locale);
      value=format.format(realParams);
      if (model != null) {
        value=Strings.replaceAll(value,"$'{'","${").toString();
        value=localizer.substitutePropertyExpressions(component,value,model);
      }
    }
  }
  return value;
}
