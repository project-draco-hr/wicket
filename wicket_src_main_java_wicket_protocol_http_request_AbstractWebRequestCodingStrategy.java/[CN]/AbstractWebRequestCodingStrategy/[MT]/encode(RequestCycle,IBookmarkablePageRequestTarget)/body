{
  final AppendingStringBuffer url=new AppendingStringBuffer(64);
  url.append(urlPrefix(requestCycle));
  final Class pageClass=requestTarget.getPageClass();
  final Application application=Application.get();
  String pageMapName=requestTarget.getPageMapName();
  if (pageMapName == null) {
    IRequestTarget currentTarget=requestCycle.getRequestTarget();
    if (currentTarget instanceof IPageRequestTarget) {
      Page currentPage=((IPageRequestTarget)currentTarget).getPage();
      final IPageMap pageMap=currentPage.getPageMap();
      if (pageMap.isDefault()) {
        pageMapName="";
      }
 else {
        pageMapName=pageMap.getName();
      }
    }
 else {
      pageMapName="";
    }
  }
  String responseRequestEncoding=application.getRequestCycleSettings().getResponseRequestEncoding();
  boolean firstParameter=true;
  if (!application.getHomePage().equals(pageClass) || !"".equals(pageMapName) || (application.getHomePage().equals(pageClass) && requestTarget instanceof BookmarkableListenerInterfaceRequestTarget)) {
    firstParameter=false;
    url.append('?');
    url.append(WebRequestCodingStrategy.BOOKMARKABLE_PAGE_PARAMETER_NAME);
    url.append('=');
    String pageClassName=pageClass.getName();
    try {
      url.append(URLEncoder.encode(pageMapName + Component.PATH_SEPARATOR + pageClassName,responseRequestEncoding));
    }
 catch (    UnsupportedEncodingException ex) {
      log.error(ex.getMessage(),ex);
      url.append(pageMapName + Component.PATH_SEPARATOR + pageClassName);
    }
  }
  final PageParameters parameters=requestTarget.getPageParameters();
  if (parameters != null) {
    for (    Object element : parameters.keySet()) {
      final String key=(String)element;
      final String value=parameters.getString(key);
      if (value != null) {
        String escapedValue=value;
        try {
          escapedValue=URLEncoder.encode(escapedValue,responseRequestEncoding);
        }
 catch (        UnsupportedEncodingException ex) {
          log.error(ex.getMessage(),ex);
        }
        if (!firstParameter) {
          url.append('&');
        }
 else {
          firstParameter=false;
          url.append('?');
        }
        url.append(key);
        url.append('=');
        url.append(escapedValue);
      }
    }
  }
  return requestCycle.getOriginalResponse().encodeURL(url);
}
