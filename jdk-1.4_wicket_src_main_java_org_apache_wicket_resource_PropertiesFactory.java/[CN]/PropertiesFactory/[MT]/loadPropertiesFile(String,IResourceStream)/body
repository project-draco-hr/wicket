{
  Properties props=propertiesCache.get(key);
  if (props != null) {
    return props;
  }
  if (resourceStream == null) {
    props=new Properties(key,ValueMap.EMPTY_MAP);
  }
 else {
    ValueMap strings=null;
    try {
      try {
        BufferedInputStream in=new BufferedInputStream(resourceStream.getInputStream());
        boolean loadAsXml=false;
        if (resourceStream instanceof IFixedLocationResourceStream) {
          String location=((IFixedLocationResourceStream)resourceStream).locationAsString();
          if (location != null) {
            String ext=Strings.lastPathComponent(location,'.').toLowerCase();
            if ("xml".equals(ext)) {
              loadAsXml=true;
            }
          }
        }
        java.util.Properties properties=new java.util.Properties();
        if (loadAsXml) {
          Streams.loadFromXml(properties,in);
        }
 else {
          properties.load(in);
        }
        strings=new ValueMap();
        Enumeration enumeration=properties.propertyNames();
        while (enumeration.hasMoreElements()) {
          String property=(String)enumeration.nextElement();
          strings.put(property,properties.getProperty(property));
        }
      }
  finally {
        resourceStream.close();
      }
    }
 catch (    ResourceStreamNotFoundException e) {
      log.warn("Unable to find resource " + resourceStream,e);
      strings=ValueMap.EMPTY_MAP;
    }
catch (    IOException e) {
      log.warn("Unable to access resource " + resourceStream,e);
      strings=ValueMap.EMPTY_MAP;
    }
    props=new Properties(key,strings);
  }
  return props;
}
