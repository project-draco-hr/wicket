{
  ISessionStore sessionStore=getSessionStore();
  Session session=sessionStore.lookup(request);
  if (session == null) {
    session=getSessionFactory().newSession(request);
    session.setLocale(request.getLocale());
    sessionStore.bind(request,session);
  }
  WicketPortletSession webSession;
  if (session instanceof WicketPortletSession) {
    webSession=(WicketPortletSession)session;
  }
 else {
    throw new WicketRuntimeException("Session created by a PortletApplication session factory " + "must be a subclass of PortletSession");
  }
  session.setApplication(this);
  webSession.initForRequest();
  return webSession;
}
