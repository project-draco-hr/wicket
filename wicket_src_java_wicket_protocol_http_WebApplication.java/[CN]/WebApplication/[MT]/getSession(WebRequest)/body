{
  final HttpSession httpSession=request.getHttpServletRequest().getSession(false);
  final String sessionAttribute=getSessionAttributePrefix(request) + Session.SESSION_ATTRIBUTE_NAME;
  WebSession webSession=null;
  if (httpSession != null) {
    webSession=(WebSession)httpSession.getAttribute(sessionAttribute);
  }
  if (webSession == null) {
    final Session session=getSessionFactory().newSession();
    if (session instanceof WebSession) {
      webSession=(WebSession)session;
    }
 else {
      throw new WicketRuntimeException("Session created by a WebApplication session factory must be a subclass of WebSession");
    }
    webSession.setLocale(request.getLocale());
    if (httpSession != null) {
      httpSession.setAttribute(sessionAttribute,webSession);
    }
    if (getApplicationSettings().getContextPath() == null) {
      getApplicationSettings().setContextPath(request.getContextPath());
    }
  }
  webSession.setApplication(this);
  webSession.initForRequest();
  return webSession;
}
