{
  final HttpSession httpSession=request.getHttpServletRequest().getSession(create);
  if (!create && (httpSession == null)) {
    return null;
  }
  final String sessionAttributePrefix="wicket-" + request.getServletPath();
  final String sessionAttribute=sessionAttributePrefix + "-" + Session.sessionAttributeName;
  WebSession webSession=(WebSession)httpSession.getAttribute(sessionAttribute);
  if (webSession == null) {
    if (!create) {
      return null;
    }
    final Session session=getSessionFactory().newSession();
    if (session instanceof WebSession) {
      webSession=(WebSession)session;
    }
 else {
      throw new WicketRuntimeException("Session created by a WebApplication session factory must be a subclass of WebSession");
    }
    webSession.setLocale(request.getLocale());
    httpSession.setAttribute(sessionAttribute,webSession);
  }
  webSession.setApplication(this);
  webSession.init(httpSession,sessionAttributePrefix);
  return webSession;
}
