{
  try {
    if (!redirect) {
      session.reset();
    }
    if (request != null) {
      setRequest(request);
    }
    if (forcedRequestHandler != null) {
      requestCycle.forceRequestHandler(forcedRequestHandler);
    }
    requestCycle.processRequestAndDetach();
    recordRequestResponse();
    setupNextRequestCycle();
    if (followRedirects && lastResponse.isRedirect()) {
      if (redirectCount == 100) {
        throw new IllegalStateException("Possible infinite redirect detected. Bailing out.");
      }
      ++redirectCount;
      Url newUrl=Url.parse(lastResponse.getRedirectUrl());
      if (newUrl.isAbsolute()) {
        throw new WicketRuntimeException("Can not follow absolute redirect URL.");
      }
      Url mergedURL=new Url(lastRequest.getUrl().getSegments(),newUrl.getQueryParameters());
      mergedURL.concatSegments(newUrl.getSegments());
      this.request.setUrl(mergedURL);
      processRequest(null,null,true);
      --redirectCount;
    }
  }
  finally {
    redirectCount=0;
  }
}
