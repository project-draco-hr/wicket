{
  final ImageValueParser valueParser=new ImageValueParser(value);
  if (valueParser.matches()) {
    final String imageReferenceName=valueParser.getImageReferenceName();
    final String specification=Strings.replaceHtmlEscapeNumber(valueParser.getSpecification());
    final String factoryName=valueParser.getFactoryName();
    final Application application=component.getApplication();
    if (!Strings.isEmpty(imageReferenceName)) {
      if (application.getSharedResources().get(Application.class,imageReferenceName,locale,style,variation,true) == null) {
        final Resource imageResource=getResourceFactory(application,factoryName).newResource(specification,locale,style,variation);
        application.getSharedResources().add(Application.class,imageReferenceName,locale,style,variation,imageResource);
      }
      resourceReference=new ResourceReference(Application.class,imageReferenceName);
      resourceReference.setLocale(locale);
      resourceReference.setStyle(style);
      resourceReference.setVariation(variation);
    }
 else {
      resource=getResourceFactory(application,factoryName).newResource(specification,locale,style,variation);
    }
  }
 else {
    throw new WicketRuntimeException("Could not generate image for value attribute '" + value + "'.  Was expecting a value attribute of the form \"[resourceFactoryName]:[resourceReferenceName]?:[factorySpecification]\".");
  }
}
