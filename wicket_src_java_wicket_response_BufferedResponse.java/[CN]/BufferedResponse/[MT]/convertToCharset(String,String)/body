{
  if (charset == null) {
    charset=backupCharset;
    backupCharset=null;
  }
  byte[] bytes=null;
  String string=stringBuffer.toString();
  ByteArrayOutputStream baos=new ByteArrayOutputStream(string.length());
  if (charset != null) {
    OutputStreamWriter osw=null;
    try {
      osw=new OutputStreamWriter(baos,charset);
      osw.write(string);
      osw.close();
      bytes=baos.toByteArray();
      this.charset=charset;
    }
 catch (    Exception ex) {
      log.debug("Can't convert response to charset: " + charset,ex);
      if (backupCharset != null) {
        try {
          osw=new OutputStreamWriter(baos,backupCharset);
          osw.write(string);
          osw.close();
          bytes=baos.toByteArray();
          this.charset=backupCharset;
        }
 catch (        Exception ex1) {
          log.debug("Can't convert response to charset: " + backupCharset,ex1);
        }
      }
    }
  }
  if (bytes == null) {
    OutputStreamWriter osw=null;
    try {
      osw=new OutputStreamWriter(baos,DEFAULT_CHARACTER_ENCODING);
      osw.write(string);
      osw.close();
      bytes=baos.toByteArray();
      this.charset=DEFAULT_CHARACTER_ENCODING;
    }
 catch (    Exception ex1) {
      bytes=string.getBytes();
    }
  }
  return bytes;
}
