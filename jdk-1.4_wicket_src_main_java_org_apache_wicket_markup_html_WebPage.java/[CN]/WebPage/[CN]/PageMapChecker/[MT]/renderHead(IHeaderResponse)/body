{
  Response response=headResponse.getResponse();
  final WebRequestCycle cycle=(WebRequestCycle)RequestCycle.get();
  final IRequestTarget target=cycle.getRequestTarget();
  if (webPage.getStatelessHint()) {
    return;
  }
  IPageMap pageMap=webPage.getPageMap();
  String name=pageMap.getName();
  if (name == null) {
    name="wicket:default";
  }
 else {
    name=name.replace('"','_');
  }
  Session session=Session.get();
  Session.PageMapAccessMetaData meta=(Session.PageMapAccessMetaData)session.getMetaData(Session.PAGEMAP_ACCESS_MDK);
  if (meta == null) {
    meta=new Session.PageMapAccessMetaData();
    session.setMetaData(Session.PAGEMAP_ACCESS_MDK,meta);
  }
  boolean firstAccess=meta.add(pageMap);
  if (firstAccess) {
    JavascriptUtils.writeOpenTag(response);
    response.write("if (window.name=='' || window.name.indexOf('wicket') > -1) { window.name=\"");
    response.write("wicket-" + name);
    response.write("\"; }");
    JavascriptUtils.writeCloseTag(response);
  }
 else {
    CharSequence url=null;
    if (target instanceof IBookmarkablePageRequestTarget) {
      IBookmarkablePageRequestTarget current=(IBookmarkablePageRequestTarget)target;
      BookmarkablePageRequestTarget redirect=new BookmarkablePageRequestTarget(session.createAutoPageMapName(),current.getPageClass(),current.getPageParameters());
      url=cycle.urlFor(redirect);
    }
 else {
      url=webPage.urlFor(INewBrowserWindowListener.INTERFACE);
    }
    JavascriptUtils.writeOpenTag(response);
    response.write("if (window.name=='' || (window.name.indexOf('wicket') > -1 && window.name!='" + "wicket-" + name + "')) { window.location=\"");
    response.write(url);
    response.write("\" + (window.location.hash != null ? window.location.hash : \"\"); }");
    JavascriptUtils.writeCloseTag(response);
  }
}
