{
  ICrypt urlCrypt=Application.get().getSecuritySettings().getCryptFactory().newCrypt();
  if (urlCrypt != null) {
    final int pos=url.toString().indexOf('?');
    if (pos > 0) {
      CharSequence urlPrefix=url.subSequence(0,pos);
      String queryString=url.subSequence(pos + 1,url.length()).toString();
      if (!queryString.startsWith("x=")) {
        queryString=shortenUrl(queryString).toString();
        final String encryptedQueryString=urlCrypt.encrypt(queryString);
        return new AppendingStringBuffer(urlPrefix).append("?x=").append(escapeUrl(encryptedQueryString));
      }
    }
  }
  return url;
}
