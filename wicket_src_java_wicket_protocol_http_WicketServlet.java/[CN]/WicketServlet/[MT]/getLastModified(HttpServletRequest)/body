{
  final String pathInfo=servletRequest.getPathInfo();
  if ((pathInfo != null) && pathInfo.startsWith(WebRequestCycle.resourceReferencePrefix)) {
    final String resourceReferenceKey=pathInfo.substring(WebRequestCycle.resourceReferencePrefix.length());
    Locale locale=servletRequest.getLocale();
    WebSession session=webApplication.getSession(servletRequest,false);
    if (session != null) {
      locale=session.getLocale();
    }
    String localizedResourceReferenceKey=SharedResources.path(resourceReferenceKey,locale,null);
    Resource resource=webApplication.getSharedResources().get(localizedResourceReferenceKey);
    if (resource == null) {
      if (locale != null && locale.getCountry() != null) {
        locale=new Locale(locale.getLanguage());
        localizedResourceReferenceKey=SharedResources.path(resourceReferenceKey,locale,null);
        resource=webApplication.getSharedResources().get(localizedResourceReferenceKey);
      }
      if (resource == null) {
        localizedResourceReferenceKey=resourceReferenceKey;
        resource=webApplication.getSharedResources().get(localizedResourceReferenceKey);
      }
    }
    if (resource != null && resource.isCacheable()) {
      if (session == null || session.isResourceCacheable(localizedResourceReferenceKey)) {
        try {
          Application.set(webApplication);
          resource.setParameters(new WebRequest(servletRequest).getParameterMap());
          IResourceStream stream=resource.getResourceStream();
          stream.length();
          Time time=stream.lastModifiedTime();
          return time != null ? time.getMilliseconds() : -1;
        }
  finally {
          Application.set(null);
        }
      }
    }
  }
  return -1;
}
