{
  long time=System.currentTimeMillis();
  Application.set(webApplication);
  if (webApplication.getRequestCycleSettings().getRenderStrategy() == IRequestCycleSettings.REDIRECT_TO_BUFFER) {
    HttpSession httpSession=servletRequest.getSession(false);
    if (httpSession == null) {
      httpSession=servletRequest.getSession(true);
      SessionBindingListener sessionBindingListener=new SessionBindingListener(webApplication,httpSession.getId());
      httpSession.setAttribute("wicket-" + sessionBindingListener.hashCode(),sessionBindingListener);
    }
    String sessionId=httpSession.getId();
    String queryString=servletRequest.getQueryString();
    if (queryString != null) {
      BufferedHttpServletResponse bufferedResponse=webApplication.popBufferedResponse(sessionId,queryString);
      if (bufferedResponse != null) {
        bufferedResponse.writeTo(servletResponse);
        return;
      }
    }
  }
  if (servletRequest.getCharacterEncoding() == null) {
    try {
      servletRequest.setCharacterEncoding(webApplication.getRequestCycleSettings().getResponseRequestEncoding());
    }
 catch (    UnsupportedEncodingException ex) {
      throw new WicketRuntimeException(ex.getMessage());
    }
  }
  final WebRequest request=webApplication.newWebRequest(servletRequest);
  final WebSession session=webApplication.getSession(request);
  final WebResponse response=webApplication.newWebResponse(servletResponse);
  response.setCharacterEncoding(webApplication.getRequestCycleSettings().getResponseRequestEncoding());
  try {
    RequestCycle cycle=session.newRequestCycle(request,response);
    try {
      cycle.request();
    }
 catch (    AbortException e) {
    }
  }
  finally {
    response.close();
    RequestLogger requestLogger=webApplication.getRequestLogger();
    if (requestLogger != null) {
      requestLogger.requestTime((System.currentTimeMillis() - time));
    }
    Session.unset();
    Application.unset();
  }
}
