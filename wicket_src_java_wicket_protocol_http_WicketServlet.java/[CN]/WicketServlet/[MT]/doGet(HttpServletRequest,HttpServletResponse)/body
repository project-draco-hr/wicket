{
  Map redirectMap=(Map)servletRequest.getSession(true).getAttribute("wicket-redirect");
  if (redirectMap != null) {
    BufferedResponse rr=(BufferedResponse)redirectMap.remove(servletRequest.getRequestURI() + "?" + servletRequest.getQueryString());
    if (rr != null) {
      PrintWriter pw=servletResponse.getWriter();
      servletResponse.setContentLength(rr.getContentLength());
      servletResponse.setContentType(rr.getContentType());
      pw.write(rr.toString());
      pw.close();
      return;
    }
  }
  final WebSession session=webApplication.getSession(servletRequest);
  final WebRequest request=new WebRequest(servletRequest);
  final WebResponse response=webApplication.getSettings().getBufferResponse() ? new BufferedWebResponse(servletResponse) : new WebResponse(servletResponse);
  try {
    RequestCycle cycle=session.newRequestCycle(request,response);
    cycle.request();
  }
  finally {
    response.close();
  }
}
