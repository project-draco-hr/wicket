{
  Application.set(webApplication);
  if (webApplication.getSettings().getRenderStrategy() == ApplicationSettings.REDIRECT_TO_BUFFER) {
    String requestUri=servletRequest.getRequestURI();
    if (servletRequest.getQueryString() != null) {
      requestUri+="?" + servletRequest.getQueryString();
    }
    BufferedResponse bufferedResponse=(BufferedResponse)webApplication.getBufferedResponse(servletRequest,requestUri);
    if (bufferedResponse != null) {
      servletResponse.setContentLength(bufferedResponse.getContentLength());
      servletResponse.setContentType(bufferedResponse.getContentType());
      final OutputStream out=servletResponse.getOutputStream();
      out.write(bufferedResponse.getBytes());
      out.close();
      return;
    }
  }
  if (servletRequest.getCharacterEncoding() == null) {
    try {
      servletRequest.setCharacterEncoding(webApplication.getSettings().getResponseRequestEncoding());
    }
 catch (    UnsupportedEncodingException ex) {
      throw new WicketRuntimeException(ex.getMessage());
    }
  }
  final WebRequest request=webApplication.newWebRequest(servletRequest);
  final WebSession session=webApplication.getSession(request,true);
  final WebResponse response=webApplication.newWebResponse(servletResponse);
  response.setCharacterEncoding(webApplication.getSettings().getResponseRequestEncoding());
  try {
    RequestCycle cycle=session.newRequestCycle(request,response);
    cycle.request();
  }
  finally {
    response.close();
    Application.set(null);
  }
}
