{
  ResourceResponse data=new ResourceResponse();
  Time lastModifiedTime=stream.lastModifiedTime();
  if (lastModifiedTime != null) {
    data.setLastModified(lastModifiedTime);
  }
  if (data.dataNeedsToBeWritten(attributes)) {
    InputStream inputStream=null;
    if (stream instanceof IResourceStreamWriter == false) {
      try {
        inputStream=stream.getInputStream();
      }
 catch (      ResourceStreamNotFoundException e) {
        data.setError(HttpServletResponse.SC_NOT_FOUND);
        close();
      }
    }
    data.setContentDisposition(contentDisposition);
    Bytes length=stream.length();
    if (length != null) {
      data.setContentLength(length.bytes());
    }
    data.setFileName(fileName);
    String contentType=stream.getContentType();
    if (contentType == null && fileName != null && Application.exists()) {
      contentType=Application.get().getMimeType(fileName);
    }
    data.setContentType(contentType);
    data.setTextEncoding(textEncoding);
    if (cacheDuration != null) {
      data.setCacheDuration(cacheDuration);
    }
    if (stream instanceof IResourceStreamWriter) {
      data.setWriteCallback(new WriteCallback(){
        @Override public void writeData(        Attributes attributes){
          ((IResourceStreamWriter)stream).write(attributes.getResponse());
          close();
        }
      }
);
    }
 else {
      final InputStream s=inputStream;
      data.setWriteCallback(new WriteCallback(){
        @Override public void writeData(        Attributes attributes){
          try {
            writeStream(attributes,s);
          }
  finally {
            close();
          }
        }
      }
);
    }
  }
  return data;
}
