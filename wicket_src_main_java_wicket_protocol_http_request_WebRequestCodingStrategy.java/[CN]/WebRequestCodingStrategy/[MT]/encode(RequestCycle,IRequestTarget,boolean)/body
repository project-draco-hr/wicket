{
  CharSequence url=pathForTarget(requestTarget);
  if (url != null) {
  }
 else   if (requestTarget instanceof IBookmarkablePageRequestTarget) {
    url=encode(requestCycle,(IBookmarkablePageRequestTarget)requestTarget);
  }
 else   if (requestTarget instanceof ISharedResourceRequestTarget) {
    url=encode(requestCycle,(ISharedResourceRequestTarget)requestTarget);
  }
 else   if (requestTarget instanceof IListenerInterfaceRequestTarget) {
    url=encode(requestCycle,(IListenerInterfaceRequestTarget)requestTarget);
  }
 else   if (requestTarget instanceof IPageRequestTarget) {
    url=encode(requestCycle,(IPageRequestTarget)requestTarget);
  }
 else {
    url=doEncode(requestCycle,requestTarget);
  }
  if (url != null) {
    String rootPath=((WebApplication)Application.get()).getRootPath();
    String filterPath=((WebApplication)Application.get()).getFilterPath();
    if (url.length() > 0 && url.charAt(0) == '/') {
      url=url.subSequence(1,url.length());
    }
    if (absolutePath) {
      url=rootPath + "/" + url;
      return requestCycle.getOriginalResponse().encodeURL(url);
    }
    String relativeUrl=requestCycle.getRequest().getRelativeURL();
    String segments="";
    for (int i=0; i < relativeUrl.length(); i++) {
      if (relativeUrl.charAt(i) == '?') {
        break;
      }
      if (relativeUrl.charAt(i) == '/') {
        segments+="../";
      }
    }
    PrependingStringBuffer prepender=new PrependingStringBuffer();
    prepender.prepend(url.toString());
    if (url.length() > 0 && (url.charAt(0) == '?' || url.charAt(0) == ';')) {
      if (segments.length() == 0) {
        if (filterPath.length() == 0) {
          prepender.prepend("./");
        }
 else {
        }
      }
    }
 else     if (filterPath.length() > 0) {
      prepender.prepend('/');
    }
    prepender.prepend(filterPath);
    if (segments.length() > 0) {
      prepender.prepend(segments);
    }
    return requestCycle.getOriginalResponse().encodeURL(prepender.toString());
  }
  return null;
}
