{
  String relativePath=getRelativePath(servletRequest);
  if (relativePath.length() == 0 && !Strings.stripJSessionId(servletRequest.getRequestURI()).endsWith("/")) {
    String redirectUrl=servletRequest.getRequestURI() + "/";
    String queryString=servletRequest.getQueryString();
    if (queryString != null) {
      redirectUrl+="?" + queryString;
    }
    servletResponse.sendRedirect(servletResponse.encodeRedirectURL(redirectUrl));
    return true;
  }
  final ClassLoader previousClassLoader=Thread.currentThread().getContextClassLoader();
  final ClassLoader newClassLoader=getClassLoader();
  try {
    if (previousClassLoader != newClassLoader) {
      Thread.currentThread().setContextClassLoader(newClassLoader);
    }
    if (servletRequest.getCharacterEncoding() == null) {
      try {
        String wicketAjaxHeader=servletRequest.getHeader("wicket-ajax");
        if (wicketAjaxHeader != null && wicketAjaxHeader.equals("true")) {
          servletRequest.setCharacterEncoding("UTF-8");
        }
 else {
          servletRequest.setCharacterEncoding(webApplication.getRequestCycleSettings().getResponseRequestEncoding());
        }
      }
 catch (      UnsupportedEncodingException ex) {
        throw new WicketRuntimeException(ex.getMessage());
      }
    }
    final WebRequest request=webApplication.newWebRequest(servletRequest);
    if (webApplication.getRequestCycleSettings().getRenderStrategy() == IRequestCycleSettings.REDIRECT_TO_BUFFER) {
      ISessionStore sessionStore=webApplication.getSessionStore();
      String sessionId=sessionStore.getSessionId(request,false);
      if (sessionId != null) {
        BufferedHttpServletResponse bufferedResponse=null;
        String queryString=servletRequest.getQueryString();
        if (!Strings.isEmpty(queryString)) {
          bufferedResponse=webApplication.popBufferedResponse(sessionId,queryString);
        }
 else {
          bufferedResponse=webApplication.popBufferedResponse(sessionId,relativePath);
        }
        if (bufferedResponse != null) {
          bufferedResponse.writeTo(servletResponse);
          return true;
        }
      }
    }
    WebResponse response=null;
    boolean externalCall=!Application.exists();
    try {
      if (externalCall) {
        Application.set(webApplication);
      }
      response=webApplication.newWebResponse(servletResponse);
      response.setAjax(request.isAjax());
      response.setCharacterEncoding(webApplication.getRequestCycleSettings().getResponseRequestEncoding());
      createRequestContext(request,response);
      final RequestCycle cycle=webApplication.newRequestCycle(request,response);
      try {
        cycle.request();
        return cycle.wasHandled();
      }
 catch (      AbortException e) {
      }
    }
  finally {
      try {
        if (response != null) {
          response.close();
        }
      }
 catch (      Exception e) {
        log.error("closing the buffer error",e);
      }
 finally {
        Session.unset();
        if (externalCall) {
          Application.unset();
          RequestContext.unset();
        }
      }
    }
  }
  finally {
    if (newClassLoader != previousClassLoader) {
      Thread.currentThread().setContextClassLoader(previousClassLoader);
    }
  }
  return true;
}
