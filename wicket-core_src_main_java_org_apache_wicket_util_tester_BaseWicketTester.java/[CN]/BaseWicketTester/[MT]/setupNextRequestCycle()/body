{
  request=new MockHttpServletRequest(application,hsession,servletContext);
  request.setURL(request.getContextPath() + request.getServletPath() + "/");
  response=new MockHttpServletResponse(request);
  ServletWebRequest servletWebRequest=createServletWebRequest();
  requestCycle=application.createRequestCycle(servletWebRequest,createServletWebResponse(servletWebRequest));
  requestCycle.setCleanupFeedbackMessagesOnDetach(false);
  ThreadContext.setRequestCycle(requestCycle);
  if (session == null) {
    createNewSession();
  }
}
