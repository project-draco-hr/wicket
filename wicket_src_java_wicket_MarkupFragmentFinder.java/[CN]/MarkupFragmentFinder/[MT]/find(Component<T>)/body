{
  MarkupContainer parentWithAssociatedMarkup=component.findParentWithAssociatedMarkup();
  MarkupStream markupStream=null;
  while (true) {
    markupStream=parentWithAssociatedMarkup.getAssociatedMarkupStream(true);
    if (component.markupIndex != -1) {
      try {
        markupStream.setCurrentIndex(component.markupIndex);
        MarkupElement elem=markupStream.get();
        if (elem instanceof ComponentTag) {
          ComponentTag tag=(ComponentTag)elem;
          if (tag.getId().equals(component.getId())) {
            return markupStream;
          }
        }
      }
 catch (      IndexOutOfBoundsException ex) {
      }
    }
    String relativePath=getComponentRelativePath(component,parentWithAssociatedMarkup);
    relativePath=((relativePath != null) && (relativePath.length() > 0) ? relativePath + IMarkup.TAG_PATH_SEPARATOR + component.getId() : component.getId());
    final Pattern re=Pattern.compile(IMarkup.TAG_PATH_SEPARATOR + "\\d+");
    final Matcher matcher=re.matcher(relativePath);
    relativePath=matcher.replaceAll("");
    int index=markupStream.findComponentIndex(relativePath);
    if (index != -1) {
      markupStream.setCurrentIndex(index);
      return markupStream;
    }
    if (parentWithAssociatedMarkup instanceof Border) {
      parentWithAssociatedMarkup=parentWithAssociatedMarkup.findParentWithAssociatedMarkup();
    }
 else {
      MarkupContainer mc=component.findParent(Fragment.class);
      if (mc != null) {
        final Fragment fragment=(Fragment)mc;
        final MarkupContainer markupProvider=fragment.getMarkupProvider();
        if (markupProvider != null) {
          markupStream=markupProvider.getMarkupStream();
          if (markupStream == null) {
            markupStream=markupProvider.getAssociatedMarkupStream(true);
          }
        }
        String fragmentId=fragment.getFragmentMarkupId();
        String componentId=getComponentRelativePath(mc,parentWithAssociatedMarkup);
        if ((componentId == null) || (componentId.length() == 0)) {
          componentId=mc.getId();
        }
 else {
          componentId+=Component.PATH_SEPARATOR + mc.getId();
        }
        relativePath=relativePath.replace(componentId,fragmentId);
        relativePath=((relativePath != null) && (relativePath.length() > 0) ? relativePath + IMarkup.TAG_PATH_SEPARATOR + component.getId() : component.getId());
        index=markupStream.findComponentIndex(relativePath);
        if (index != -1) {
          markupStream.setCurrentIndex(index);
          return markupStream;
        }
      }
      throw new WicketRuntimeException("Unable to find the markup for the component: " + component.getId());
    }
    markupStream=null;
  }
}
