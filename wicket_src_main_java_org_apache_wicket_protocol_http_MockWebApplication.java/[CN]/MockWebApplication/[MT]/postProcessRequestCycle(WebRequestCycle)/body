{
  previousRenderedPage=lastRenderedPage;
  if (cycle.getResponse() instanceof WebResponse) {
    final MockHttpServletResponse httpResponse=(MockHttpServletResponse)cycle.getWebResponse().getHttpServletResponse();
    if (httpResponse.isRedirect()) {
      lastRenderedPage=generateLastRenderedPage(cycle);
      MockHttpServletRequest newHttpRequest=new MockHttpServletRequest(application,servletSession,application.getServletContext());
      newHttpRequest.setRequestToRedirectString(httpResponse.getRedirectLocation());
      wicketRequest=application.newWebRequest(newHttpRequest);
      cycle=createRequestCycle();
      cycle.request();
    }
 else {
      String url=httpResponse.getHeader("Ajax-Location");
      if (url != null) {
        MockHttpServletRequest newHttpRequest=new MockHttpServletRequest(application,servletSession,application.getServletContext());
        newHttpRequest.setRequestToRedirectString(url);
        wicketRequest=application.newWebRequest(newHttpRequest);
        cycle=createRequestCycle();
        cycle.request();
      }
    }
  }
  lastRenderedPage=generateLastRenderedPage(cycle);
  Session.set(getWicketSession());
  if (getLastRenderedPage() instanceof ExceptionErrorPage) {
    throw (RuntimeException)((ExceptionErrorPage)getLastRenderedPage()).getThrowable();
  }
}
