{
  final ResourceResponse resourceResponse=new ResourceResponse();
  if (resourceResponse.dataNeedsToBeWritten(attributes)) {
    final IResourceStream resourceStream=getResourceStream();
    if (resourceStream == null)     return sendResourceError(resourceResponse,404,"Unable to find resource");
    resourceResponse.setContentType(resourceStream.getContentType());
    final Time lastModified=resourceStream.lastModifiedTime();
    if (lastModified != null)     resourceResponse.setLastModified(lastModified.toDate());
    try {
      final byte[] bytes;
      try {
        bytes=IOUtils.toByteArray(resourceStream.getInputStream());
      }
  finally {
        resourceStream.close();
      }
      resourceResponse.setContentLength(bytes.length);
      resourceResponse.setWriteCallback(new WriteCallback(){
        @Override public void writeData(        Attributes attributes){
          attributes.getResponse().write(bytes);
        }
      }
);
    }
 catch (    IOException e) {
      log.debug(e.getMessage(),e);
      return sendResourceError(resourceResponse,500,"Unable to read resource stream");
    }
catch (    ResourceStreamNotFoundException e) {
      log.debug(e.getMessage(),e);
      return sendResourceError(resourceResponse,500,"Unable to open resource stream");
    }
  }
  if (Application.get().getResourceSettings().getUseTimestampOnResources()) {
    resourceResponse.setCacheDuration(RequestUtils.MAX_CACHE_DURATION);
    resourceResponse.setCachePublic(true);
  }
  return resourceResponse;
}
