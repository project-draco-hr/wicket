{
  if (errorAttributes != null && !Strings.isEmpty(errorAttributes.getRequestUri())) {
    String problematicURI=Url.parse(errorAttributes.getRequestUri(),getCharset()).toString();
    Url url=getContextRelativeUrl(problematicURI,filterPrefix);
    return setParameters(url);
  }
 else   if (!isAjax()) {
    return getContextRelativeUrl(httpServletRequest.getRequestURI(),filterPrefix);
  }
 else {
    String base=null;
    base=getHeader(HEADER_AJAX_BASE_URL);
    if (base == null) {
      base=getRequestParameters().getParameterValue(PARAM_AJAX_BASE_URL).toString(null);
    }
    Checks.notNull(base,"Current ajax request is missing the base url header or parameter");
    return setParameters(Url.parse(base,getCharset()));
  }
}
