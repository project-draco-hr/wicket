{
  if (tempFile == null) {
    File tempDir=repository;
    if (tempDir == null) {
      String systemTmp=null;
      try {
        systemTmp=System.getProperty("java.io.tmpdir");
      }
 catch (      SecurityException e) {
        throw new RuntimeException("Reading property java.io.tmpdir is not allowed" + " for the current security settings. The repository location needs to be" + " set manually, or upgrade permissions to allow reading the tmpdir property.");
      }
      tempDir=new File(systemTmp);
    }
    try {
      do {
        String tempFileName="upload_" + UID + "_"+ getUniqueId()+ ".tmp";
        tempFile=new File(tempDir,tempFileName);
      }
 while (!tempFile.createNewFile());
    }
 catch (    IOException e) {
      throw new RuntimeException("Could not create the temp file for upload",e);
    }
    if (fileUploadCleaner != null) {
      fileUploadCleaner.track(tempFile,this);
    }
  }
  return tempFile;
}
