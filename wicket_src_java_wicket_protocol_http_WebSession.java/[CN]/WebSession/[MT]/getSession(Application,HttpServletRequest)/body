{
  final javax.servlet.http.HttpSession httpServletSession=request.getSession(true);
  final String sessionAttributeName="session" + request.getServletPath();
  WebSession webSession=(WebSession)httpServletSession.getAttribute(sessionAttributeName);
  if (webSession == null) {
    final Session session=application.getSessionFactory().newSession();
    if (session instanceof WebSession) {
      webSession=(WebSession)session;
    }
 else {
      throw new WicketRuntimeException("Session created by a WebApplication session factory must be a subclass of WebSession");
    }
    webSession.setLocale(request.getLocale());
  }
  webSession.httpSession=httpServletSession;
  httpServletSession.setAttribute(sessionAttributeName,webSession);
  Session.set(webSession);
  return webSession;
}
