{
  final List autoAddList=new ArrayList();
  this.markupFilterChain=newFilterChain(autoAddList);
  initFilterChain();
  final List list=new ArrayList();
  try {
    for (ComponentTag tag; null != (tag=(ComponentTag)markupFilterChain.nextTag()); ) {
      boolean add=(tag.getId() != null);
      if (!add && tag.getXmlTag().isClose()) {
        add=((tag.getOpenTag() != null) && (tag.getOpenTag().getId() != null));
      }
      RawMarkup replaceTag=null;
      if (tag.isOpen() && "html".equals(tag.getName().toLowerCase())) {
        add|=determineWicketNamespace(tag);
        if ((add == true) && (tag.getId() == null)) {
          replaceTag=new RawMarkup(tag.toString());
        }
      }
      if (add || (autoAddList.size() > 0)) {
        final CharSequence text=xmlParser.getInputFromPositionMarker(tag.getPos());
        if (text.length() > 0) {
          String rawMarkup=text.toString();
          if (stripComments) {
            rawMarkup=rawMarkup.replaceAll("<!--(.|\n|\r)*?-->","");
          }
          if (compressWhitespace) {
            rawMarkup=rawMarkup.replaceAll("[ \\t]+"," ");
            rawMarkup=rawMarkup.replaceAll("( ?[\\r\\n] ?)+","\n");
          }
          list.add(new RawMarkup(rawMarkup));
        }
        if ((add == false) && (autoAddList.size() > 0)) {
          xmlParser.setPositionMarker(tag.getPos());
        }
        list.addAll(autoAddList);
        autoAddList.clear();
      }
      if (add) {
        if (!WicketRemoveTagHandler.IGNORE.equals(tag.getId())) {
          if (replaceTag != null) {
            list.add(replaceTag);
          }
 else {
            list.add(tag);
          }
        }
        xmlParser.setPositionMarker();
      }
    }
  }
 catch (  ParseException ex) {
    final CharSequence text=xmlParser.getInputFromPositionMarker(-1);
    if (text.length() > 0) {
      list.add(new RawMarkup(text));
    }
    Markup markup=new Markup(this.resource,list,getXmlDeclaration(),getEncoding(),this.wicketNamespace);
    MarkupStream markupStream=new MarkupStream(markup);
    markupStream.setCurrentIndex(list.size() - 1);
    throw new MarkupException(markupStream,ex.getMessage());
  }
  final CharSequence text=xmlParser.getInputFromPositionMarker(-1);
  if (text.length() > 0) {
    list.add(new RawMarkup(text));
  }
  for (int i=0; i < list.size(); i++) {
    MarkupElement elem=(MarkupElement)list.get(i);
    if (elem instanceof ComponentTag) {
      ((ComponentTag)elem).makeImmutable();
    }
  }
  return Collections.unmodifiableList(list);
}
