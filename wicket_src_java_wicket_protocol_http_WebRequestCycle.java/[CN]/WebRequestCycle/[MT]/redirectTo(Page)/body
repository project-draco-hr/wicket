{
  String redirectUrl=page.urlFor(page,IRedirectListener.class);
  ApplicationSettings settings=application.getSettings();
  if ((settings.getRenderStrategy() == ApplicationSettings.REDIRECT_TO_BUFFER) && (application instanceof WebApplication)) {
    final Response currentResponse=getResponse();
    try {
      final BufferedResponse redirectResponse=new BufferedResponse(redirectUrl){
        public String encodeURL(        String url){
          return currentResponse.encodeURL(url);
        }
      }
;
      redirectResponse.setCharacterEncoding(currentResponse.getCharacterEncoding());
      setResponse(redirectResponse);
      if (getInvokePage() == getResponsePage()) {
        setInvokePage(null);
      }
      page.doRender();
      setResponse(currentResponse);
      final String responseRedirect=redirectResponse.getRedirectUrl();
      if (redirectUrl != responseRedirect) {
        redirectUrl=redirectResponse.getRedirectUrl();
      }
 else       if (redirectResponse.getContentLength() > 0) {
        redirectResponse.setCharacterEncoding(currentResponse.getCharacterEncoding());
        redirectResponse.close();
        ((WebApplication)application).addRedirect(getWebRequest().getHttpServletRequest(),redirectUrl,redirectResponse);
      }
    }
 catch (    RuntimeException ex) {
      setResponse(currentResponse);
      internalOnRuntimeException(page,ex);
      return;
    }
  }
 else {
    session.touch(page);
    page.internalEndRequest();
  }
  response.redirect(redirectUrl);
}
