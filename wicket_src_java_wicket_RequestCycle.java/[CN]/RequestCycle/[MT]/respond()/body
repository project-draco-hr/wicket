{
  final IResourceStream ajax=getAjaxResponse();
  if (ajax != null) {
    getResponse().setContentType(ajax.getContentType());
    OutputStream os=getResponse().getOutputStream();
    try {
      InputStream is=ajax.getInputStream();
      byte[] bytes=new byte[512];
      int read=is.read(bytes);
      while (read != -1) {
        os.write(bytes,0,read);
        read=is.read(bytes);
      }
      os.flush();
    }
 catch (    Exception e) {
      log.error("Error sending AJAX response",e);
      throw new ServletException(e);
    }
 finally {
      try {
        ajax.close();
      }
 catch (      IOException e) {
        e.printStackTrace();
      }
    }
  }
 else {
    final Page page=getResponsePage();
    if (page != null) {
      try {
        if (getRedirect()) {
          redirectTo(page);
        }
 else {
          page.request();
        }
      }
 catch (      RuntimeException e) {
        onRuntimeException(page,e);
      }
    }
  }
}
