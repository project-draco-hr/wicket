{
synchronized (session) {
    session.setApplication(application);
    session.setRequestCycle(this);
    try {
      onRender();
    }
 catch (    StackOverflowError e) {
      throw new ServletException("Wicket could not render page",e);
    }
catch (    RuntimeException e) {
      Page currentPage=getPage();
      if (currentPage != null) {
        currentPage.reset();
      }
      onException(e);
    }
 finally {
      response.close();
      session.setRequestCycle(null);
      threadDetach();
    }
  }
}
