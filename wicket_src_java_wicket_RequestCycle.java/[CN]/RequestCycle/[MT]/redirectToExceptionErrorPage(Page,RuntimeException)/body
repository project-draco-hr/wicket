{
  final ApplicationSettings settings=application.getSettings();
  if (settings.getUnexpectedExceptionDisplay() != ApplicationSettings.SHOW_NO_EXCEPTION_PAGE) {
    Class internalErrorPageClass=application.getPages().getInternalErrorPage();
    Page responsePage=getResponsePage();
    Class responseClass=responsePage != null ? responsePage.getClass() : null;
    if (responseClass != internalErrorPageClass && settings.getUnexpectedExceptionDisplay() == ApplicationSettings.SHOW_INTERNAL_ERROR_PAGE) {
      setResponsePage(session.getPageFactory(page).newPage(internalErrorPageClass));
    }
 else     if (responseClass != ExceptionErrorPage.class) {
      setResponsePage(new ExceptionErrorPage(e,getResponsePage()));
    }
 else {
      throw new ServletException("Internal Error: Could not render error page " + page,e);
    }
    redirectTo(getResponsePage());
  }
}
