{
  PageMap pageMap=getPageMap();
  if (getPopupSettings() != null) {
    if (pageMap != null) {
      throw new IllegalStateException("You cannot set the page map for a link that also has popup settings");
    }
    final String popupPageMapName="popup" + popupNumber;
    popupNumber++;
    pageMap=PageMap.forName(popupPageMapName);
    if (pageMap == null) {
      pageMap=getSession().newPageMap(popupPageMapName);
    }
  }
  return getPage().urlFor(pageMap,pageClass,parameters);
}
