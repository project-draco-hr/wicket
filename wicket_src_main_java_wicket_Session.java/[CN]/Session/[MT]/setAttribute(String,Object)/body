{
  RequestCycle cycle=RequestCycle.get();
  if (cycle == null) {
    throw new WicketRuntimeException("Can not set the attribute. No RequestCycle available");
  }
  ISessionStore store=getSessionStore();
  Request request=cycle.getRequest();
  if (value == this) {
    Object current=store.getAttribute(request,name);
    if (current == null) {
      String id=store.getSessionId(request,false);
      if (id != null) {
        store.bind(request,(Session)value);
      }
    }
  }
  String valueTypeName=(value != null ? value.getClass().getName() : "null");
  try {
    final ByteArrayOutputStream out=new ByteArrayOutputStream();
    new ObjectOutputStream(out).writeObject(value);
    log.debug("Stored attribute " + name + "{ "+ valueTypeName+ "} with size: "+ Bytes.bytes(out.size()));
  }
 catch (  Exception e) {
    throw new WicketRuntimeException("Internal error cloning object. Make sure all dependent objects implement Serializable. Class: " + valueTypeName,e);
  }
  store.setAttribute(request,name,value);
}
