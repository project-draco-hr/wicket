{
  ICrypt urlCrypt=Application.get().getSecuritySettings().getCryptFactory().newCrypt();
  if (urlCrypt != null) {
    final int pos=url.toString().indexOf('?');
    if (pos > -1) {
      CharSequence urlPrefix=url.subSequence(0,pos);
      String queryString=url.subSequence(pos + 1,url.length()).toString();
      if (!queryString.startsWith("x=")) {
        queryString=shortenUrl(queryString).toString();
        String encryptedQueryString=urlCrypt.encryptUrlSafe(queryString);
        encryptedQueryString=WicketURLEncoder.QUERY_INSTANCE.encode(encryptedQueryString);
        return new AppendingStringBuffer(urlPrefix).append("?x=").append(encryptedQueryString);
      }
    }
  }
  return url;
}
