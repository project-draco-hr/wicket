{
  Class containerClass=clazz;
  if (clazz == null) {
    containerClass=container.getClass();
  }
 else {
    if (!clazz.isAssignableFrom(container.getClass())) {
      throw new WicketRuntimeException("Parameter clazz must be instance of container");
    }
  }
  final CharSequence key=markupKey(container,clazz);
  Markup markup=(Markup)markupCache.get(key);
  if (markup == null) {
synchronized (markupCache) {
      markup=(Markup)markupCache.get(key);
      if (markup == null) {
        final IResourceStream resourceStream=container.newMarkupResourceStream(containerClass);
        if (resourceStream != null) {
          final MarkupResourceStream markupResource;
          if (resourceStream instanceof MarkupResourceStream) {
            markupResource=(MarkupResourceStream)resourceStream;
          }
 else {
            markupResource=new MarkupResourceStream(resourceStream,new ContainerInfo(container),containerClass);
          }
          markup=loadMarkupAndWatchForChanges(container,key,markupResource);
        }
 else {
          markup=Markup.NO_MARKUP;
          markupCache.put(key,markup);
        }
      }
    }
  }
  return markup;
}
