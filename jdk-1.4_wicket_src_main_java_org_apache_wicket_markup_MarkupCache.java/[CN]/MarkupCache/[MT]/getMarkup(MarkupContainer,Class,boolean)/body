{
  Class containerClass=clazz;
  if (clazz == null) {
    containerClass=container.getClass();
  }
 else {
    if (!clazz.isAssignableFrom(container.getClass())) {
      throw new WicketRuntimeException("Parameter clazz must be instance of container");
    }
  }
  final String cacheKey=getMarkupCacheKeyProvider(container).getCacheKey(container,clazz);
  Markup markup=(enforceReload == false ? getMarkupFromCache(cacheKey,container) : null);
  if (markup == null) {
    if (log.isDebugEnabled()) {
      log.debug("Load markup: cacheKey=" + cacheKey);
    }
    final IResourceStream resourceStream=getMarkupResourceStreamProvider(container).getMarkupResourceStream(container,containerClass);
    if (resourceStream != null) {
      final MarkupResourceStream markupResourceStream;
      if (resourceStream instanceof MarkupResourceStream) {
        markupResourceStream=(MarkupResourceStream)resourceStream;
      }
 else {
        markupResourceStream=new MarkupResourceStream(resourceStream,new ContainerInfo(container),containerClass);
      }
      markupResourceStream.setCacheKey(cacheKey);
      markup=loadMarkupAndWatchForChanges(container,markupResourceStream,enforceReload);
    }
 else {
      markup=onMarkupNotFound(cacheKey,container);
    }
  }
  return markup;
}
