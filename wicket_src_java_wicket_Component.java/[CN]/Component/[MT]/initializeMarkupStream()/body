{
  MarkupContainer parent=getParent();
  MarkupContainer parentWithAssociatedMarkup=findParentWithAssociatedMarkup();
  MarkupStream markupStream=parentWithAssociatedMarkup.getAssociatedMarkupStream();
  if (this.markupStreamPosition != -1) {
    markupStream.setCurrentIndex(this.markupStreamPosition);
  }
 else {
    String componentPath=parent.getPageRelativePath();
    String parentWithAssociatedMarkupPath=parentWithAssociatedMarkup.getPageRelativePath();
    String relativePath=componentPath.substring(parentWithAssociatedMarkupPath.length());
    int index=markupStream.findComponentIndex(relativePath,getId());
    if (index == -1) {
      throw new WicketRuntimeException("Unable to determine markup for component: " + this.toString());
    }
    markupStream.setCurrentIndex(index);
  }
  return markupStream;
}
