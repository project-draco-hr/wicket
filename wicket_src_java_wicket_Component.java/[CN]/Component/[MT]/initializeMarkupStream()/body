{
  MarkupContainer parent=getParent();
  MarkupContainer parentWithAssociatedMarkup=findParentWithAssociatedMarkup();
  MarkupStream markupStream=null;
  while (markupStream == null) {
    markupStream=parentWithAssociatedMarkup.getAssociatedMarkupStream(true);
    String componentPath=parent.getPageRelativePath();
    String parentWithAssociatedMarkupPath=parentWithAssociatedMarkup.getPageRelativePath();
    String relativePath=componentPath.substring(parentWithAssociatedMarkupPath.length());
    if (relativePath.startsWith(":")) {
      relativePath=relativePath.substring(1);
    }
    int index=markupStream.findComponentIndex(relativePath,getId());
    if (index != -1) {
      markupStream.setCurrentIndex(index);
    }
 else {
      markupStream=null;
      if (parentWithAssociatedMarkup instanceof Border) {
        parentWithAssociatedMarkup=parentWithAssociatedMarkup.findParentWithAssociatedMarkup();
      }
    }
  }
  if (markupStream == null) {
    throw new WicketRuntimeException("Unable to determine markup for component: " + this.toString());
  }
  return markupStream;
}
