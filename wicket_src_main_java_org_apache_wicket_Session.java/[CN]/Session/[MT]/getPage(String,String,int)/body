{
  if (log.isDebugEnabled()) {
    log.debug("Getting page [path = " + path + ", versionNumber = "+ versionNumber+ "]");
  }
  IPageMap pageMap=pageMapForName(pageMapName,pageMapName == PageMap.DEFAULT_NAME);
  if (pageMap != null) {
synchronized (usedPageMaps) {
      if (pageMapsUsedInRequest == null) {
        pageMapsUsedInRequest=new HashMap<IPageMap,PageMapsUsedInRequestEntry>(3);
      }
    }
synchronized (pageMapsUsedInRequest) {
      long startTime=System.currentTimeMillis();
      Duration timeout=Application.get().getRequestCycleSettings().getTimeout();
      PageMapsUsedInRequestEntry entry=pageMapsUsedInRequest.get(pageMap);
      Thread t=entry != null ? entry.thread : null;
      while (t != null && t != Thread.currentThread()) {
        if (isCurrentRequestValid(entry.requestCycle) == false) {
          throw new IgnoreAjaxRequestException();
        }
        try {
          pageMapsUsedInRequest.wait(timeout.getMilliseconds());
        }
 catch (        InterruptedException ex) {
          throw new WicketRuntimeException(ex);
        }
        entry=pageMapsUsedInRequest.get(pageMap);
        t=entry != null ? entry.thread : null;
        if (t != null && t != Thread.currentThread() && (startTime + timeout.getMilliseconds()) < System.currentTimeMillis()) {
          AppendingStringBuffer asb=new AppendingStringBuffer(100);
          asb.append("After " + timeout + " the Pagemap "+ pageMapName+ " is still locked by: "+ t+ ", giving up trying to get the page for path: "+ path);
          try {
            StackTraceElement[] stackTrace=t.getStackTrace();
            asb.append("\n\tBegin of stack trace of " + t);
            for (            StackTraceElement stackTraceElement : stackTrace) {
              asb.append("\n\t");
              asb.append(stackTraceElement);
            }
            asb.append("\n\tEnd of stack trace of " + t);
          }
 catch (          Exception e) {
          }
          throw new WicketRuntimeException(asb.toString());
        }
      }
      PageMapsUsedInRequestEntry newEntry=new PageMapsUsedInRequestEntry();
      newEntry.thread=Thread.currentThread();
      newEntry.requestCycle=RequestCycle.get();
      pageMapsUsedInRequest.put(pageMap,newEntry);
      final String id=Strings.firstPathComponent(path,Component.PATH_SEPARATOR);
      Page<?> page=pageMap.get(Integer.parseInt(id),versionNumber);
      if (page == null) {
        pageMapsUsedInRequest.remove(pageMap);
        pageMapsUsedInRequest.notifyAll();
      }
 else {
        page.onPageAttached();
        touch(page);
      }
      return page;
    }
  }
  return null;
}
