{
  boolean needToChange=false;
  StringBuilder out=new StringBuilder(s.length());
  Charset charset;
  CharArrayWriter charArrayWriter=new CharArrayWriter();
  if (enc == null) {
    throw new NullPointerException("charsetName");
  }
  try {
    charset=Charset.forName(enc);
  }
 catch (  IllegalCharsetNameException e) {
    throw new RuntimeException(new UnsupportedEncodingException(enc));
  }
catch (  UnsupportedCharsetException e) {
    throw new RuntimeException(new UnsupportedEncodingException(enc));
  }
  boolean stopEncoding=false;
  for (int i=0; i < s.length(); ) {
    int c=s.charAt(i);
    if ((stopEncoding == false) && (c == stopChar)) {
      stopEncoding=true;
    }
    if ((stopEncoding == true) || dontNeedEncoding.get(c)) {
      if (c == ' ') {
        c='+';
        needToChange=true;
      }
      out.append((char)c);
      i++;
    }
 else {
      do {
        charArrayWriter.write(c);
        if (c >= 0xD800 && c <= 0xDBFF) {
          if ((i + 1) < s.length()) {
            int d=s.charAt(i + 1);
            if (d >= 0xDC00 && d <= 0xDFFF) {
              charArrayWriter.write(d);
              i++;
            }
          }
        }
        i++;
      }
 while (i < s.length() && !dontNeedEncoding.get((c=s.charAt(i))));
      charArrayWriter.flush();
      String str=new String(charArrayWriter.toCharArray());
      byte[] ba;
      try {
        ba=str.getBytes(charset.name());
      }
 catch (      UnsupportedEncodingException e) {
        throw new RuntimeException(e);
      }
      for (      byte b : ba) {
        out.append('%');
        char ch=Character.forDigit((b >> 4) & 0xF,16);
        if (Character.isLetter(ch)) {
          ch-=caseDiff;
        }
        out.append(ch);
        ch=Character.forDigit(b & 0xF,16);
        if (Character.isLetter(ch)) {
          ch-=caseDiff;
        }
        out.append(ch);
      }
      charArrayWriter.reset();
      needToChange=true;
    }
  }
  return (needToChange ? out.toString() : s);
}
