{
  Checks.argumentNotNull(url,"url");
  if (url.isAbsolute()) {
    return url.toString();
  }
 else {
    List<String> baseUrlSegments=getBaseUrl().getSegments();
    List<String> urlSegments=new ArrayList<String>(url.getSegments());
    List<String> newSegments=new ArrayList<String>();
    int common=0;
    String last=null;
    for (    String s : baseUrlSegments) {
      if (!urlSegments.isEmpty() && s.equals(urlSegments.get(0))) {
        ++common;
        last=urlSegments.remove(0);
      }
    }
    if (last != null && (urlSegments.isEmpty() || baseUrlSegments.size() == common)) {
      --common;
      urlSegments.add(0,last);
    }
    for (int i=common + 1; i < baseUrlSegments.size(); ++i) {
      newSegments.add("..");
    }
    newSegments.addAll(urlSegments);
    return new Url(newSegments,url.getQueryParameters()).toString();
  }
}
