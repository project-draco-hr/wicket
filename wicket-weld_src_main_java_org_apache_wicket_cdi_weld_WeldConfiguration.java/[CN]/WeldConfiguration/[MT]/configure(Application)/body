{
  if (beanManager == null) {
    resolveBeanManager(((WebApplication)application).getServletContext());
  }
  if (beanManager == null) {
    throw new IllegalStateException("Configuration does not have a BeanManager instance configured");
  }
  WeldContainer container=new WeldContainer(beanManager);
  container.bind(application);
  application.getComponentInstantiationListeners().add(new CdiInjector(container));
  if (propagation != ConversationPropagation.NONE) {
    application.getRequestCycleListeners().add(new ConversationPropagator(container,propagation));
  }
  return container;
}
