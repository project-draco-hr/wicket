{
  if (!url.endsWith("/")) {
    url.append("/");
  }
  Set<String> parameterNamesToAdd=new HashSet<String>(parameters.keySet());
  boolean foundParameter=false;
  int lastSpecifiedParameter=parameterNames.length;
  while (lastSpecifiedParameter != 0 && !foundParameter) {
    foundParameter=parameters.containsKey(parameterNames[--lastSpecifiedParameter]);
  }
  if (foundParameter) {
    for (int i=0; i <= lastSpecifiedParameter; i++) {
      String parameterName=parameterNames[i];
      final Object param=parameters.get(parameterName);
      String value=param instanceof String[] ? ((String[])param)[0] : (String)param;
      if (value == null) {
        value="";
      }
      if (!url.endsWith("/")) {
        url.append("/");
      }
      url.append(urlEncodePathComponent(value));
      parameterNamesToAdd.remove(parameterName);
    }
  }
  if (!parameterNamesToAdd.isEmpty()) {
    boolean first=true;
    for (    String parameterName : parameterNamesToAdd) {
      url.append(first ? '?' : '&');
      final Object param=parameters.get(parameterName);
      String value=param instanceof String[] ? ((String[])param)[0] : (String)param;
      url.append(urlEncodeQueryComponent(parameterName)).append("=").append(urlEncodeQueryComponent(value));
      first=false;
    }
  }
}
