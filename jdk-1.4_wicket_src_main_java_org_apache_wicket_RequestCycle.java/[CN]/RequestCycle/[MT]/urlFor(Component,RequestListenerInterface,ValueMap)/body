{
  final Page page=component.getPage();
  final IRequestTarget target;
  if (listener != IRedirectListener.INTERFACE && component.isStateless() && page.isBookmarkable()) {
    PageParameters pageParameters=page.getPageParameters();
    if (pageParameters == null) {
      pageParameters=new PageParameters();
    }
    if (params != null) {
      Iterator it=params.entrySet().iterator();
      while (it.hasNext()) {
        final Map.Entry entry=(Entry)it.next();
        final String key=entry.getKey().toString();
        final String value=entry.getValue().toString();
        pageParameters.add(encode(key),encode(value));
      }
    }
    target=new BookmarkableListenerInterfaceRequestTarget(page.getPageMapName(),page.getClass(),pageParameters,component,listener);
    return encodeUrlFor(target);
  }
 else {
    page.setPageStateless(Boolean.FALSE);
    final Session session=getSession();
    if (session.isTemporary()) {
      session.bind();
    }
    target=new ListenerInterfaceRequestTarget(page,component,listener);
    CharSequence url=encodeUrlFor(target);
    if (params != null) {
      AppendingStringBuffer buff=new AppendingStringBuffer(url);
      Iterator it=params.entrySet().iterator();
      while (it.hasNext()) {
        final Map.Entry entry=(Entry)it.next();
        final String key=entry.getKey().toString();
        final String value=entry.getValue().toString();
        buff.append("&");
        buff.append(encode(key));
        buff.append("=");
        buff.append(encode(value));
      }
      url=buff;
    }
    return url;
  }
}
