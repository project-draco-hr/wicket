{
  final WebRequestCycle cycle=(WebRequestCycle)getRequestCycle();
  final IRequestTarget target=cycle.getRequestTarget();
  int initialAccessStackSize=0;
  if (getApplication().getRequestCycleSettings().getRenderStrategy() == IRequestCycleSettings.REDIRECT_TO_RENDER && target instanceof RedirectPageRequestTarget) {
    initialAccessStackSize=1;
  }
  final ArrayListStack accessStack=getPageMap().getAccessStack();
  if (accessStack.size() > initialAccessStackSize) {
    CharSequence url=null;
    if (target instanceof IBookmarkablePageRequestTarget) {
      IBookmarkablePageRequestTarget current=(IBookmarkablePageRequestTarget)target;
      BookmarkablePageRequestTarget redirect=new BookmarkablePageRequestTarget(getSession().createAutoPageMapName(),current.getPageClass(),current.getPageParameters());
      url=cycle.urlFor(redirect);
    }
 else {
      url=urlFor(INewBrowserWindowListener.INTERFACE);
    }
    if (cycle.getWebRequest().getCookies() == null) {
      response.write("<script language=\"javascript\">if((history.length == 0 && document.all) || (history.length == 1 && !document.all)){ if (!document.all) window.location.hash='some-random-hash!'; document.location.href = '");
      response.write(url);
      response.write("'}</script>");
    }
 else {
      if (onUnLoadModel == null) {
        onUnLoadModel=new Model(){
          private static final long serialVersionUID=1L;
          /** 
 * @see wicket.model.Model#getObject(wicket.Component)
 */
          public Object getObject(          Component component){
            return "deleteCookie('pagemap-" + getPageMap().getName() + "');";
          }
        }
;
        getBodyContainer().addOnUnLoadModifier(onUnLoadModel);
      }
      response.write("<script type=\"text/javascript\" src=\"");
      response.write(urlFor(cookiesResource));
      response.write("\"></script>\n");
      response.write("<script language=\"javascript\">\n");
      response.write("var pagemapcookie = getCookie('pagemap-");
      response.write(getPageMap().getName());
      response.write("');\n");
      response.write("if(!pagemapcookie && pagemapcookie != '1'){setCookie('pagemap-");
      response.write(getPageMap().getName());
      response.write("',1);}\n");
      response.write("else {document.location.href = '");
      response.write(url);
      response.write("';}\n");
      response.write("</script>\n");
    }
  }
}
