{
  Response response=headResponse.getResponse();
  final WebRequestCycle cycle=(WebRequestCycle)getRequestCycle();
  final IRequestTarget target=cycle.getRequestTarget();
  String name=getPageMap().getName();
  if (name == null) {
    name="wicket:default";
  }
 else {
    name=name.replace('"','_');
  }
  Session session=getSession();
  PageMapAccessMetaData meta=(PageMapAccessMetaData)session.getMetaData(PAGEMAP_ACCESS_MDK);
  if (meta == null) {
    meta=new PageMapAccessMetaData();
    session.setMetaData(PAGEMAP_ACCESS_MDK,meta);
  }
  boolean firstAccess=false;
  if (!meta.pageMapNames.contains(name)) {
    firstAccess=true;
    meta.pageMapNames.add(name);
  }
  CharSequence url=null;
  if (target instanceof IBookmarkablePageRequestTarget) {
    IBookmarkablePageRequestTarget current=(IBookmarkablePageRequestTarget)target;
    BookmarkablePageRequestTarget redirect=new BookmarkablePageRequestTarget(getSession().createAutoPageMapName(),current.getPageClass(),current.getPageParameters());
    url=cycle.urlFor(redirect);
  }
 else {
    url=urlFor(INewBrowserWindowListener.INTERFACE);
  }
  if (firstAccess) {
    JavascriptUtils.writeOpenTag(response);
    response.write("window.name=\"");
    response.write(name);
    response.write("\";");
    JavascriptUtils.writeCloseTag(response);
  }
 else {
    JavascriptUtils.writeOpenTag(response);
    response.write("if (window.name=='') { window.location=\"");
    response.write(url);
    response.write("\"; }");
    JavascriptUtils.writeCloseTag(response);
  }
}
