{
  String redirectUrl=null;
  IRequestCycleSettings settings=application.getRequestCycleSettings();
  if ((settings.getRenderStrategy() == IRequestCycleSettings.REDIRECT_TO_BUFFER) && (application instanceof WebApplication) && !(getWebRequest().isAjax())) {
    final WebResponse currentResponse=getWebResponse();
    try {
      if (getWebRequest() instanceof ServletWebRequest) {
        ((ServletWebRequest)getWebRequest()).setWicketRedirectUrl(Strings.replaceAll(page.urlFor(IRedirectListener.INTERFACE).toString(),"../","").toString());
      }
      final BufferedHttpServletResponse servletResponse=new BufferedHttpServletResponse(currentResponse.getHttpServletResponse());
      final WebResponse redirectResponse=new WebResponse(servletResponse){
        @Override public CharSequence encodeURL(        CharSequence url){
          return currentResponse.encodeURL(url);
        }
      }
;
      redirectResponse.setCharacterEncoding(currentResponse.getCharacterEncoding());
      setResponse(redirectResponse);
      page.render();
      setResponse(currentResponse);
      final String responseRedirect=servletResponse.getRedirectUrl();
      if (responseRedirect != null) {
        redirectUrl=responseRedirect;
      }
 else       if (servletResponse.getContentLength() > 0) {
        servletResponse.filter(currentResponse);
        servletResponse.setCharacterEncoding(currentResponse.getCharacterEncoding());
        servletResponse.close();
        if (getWebRequest() instanceof ServletWebRequest) {
          ((ServletWebRequest)getWebRequest()).setWicketRedirectUrl(null);
        }
        redirectUrl=page.urlFor(IRedirectListener.INTERFACE).toString();
        String stripped=Strings.replaceAll(redirectUrl,"../","").toString();
        int index=stripped.indexOf("?");
        String sessionId=getApplication().getSessionStore().getSessionId(request,true);
        ((WebApplication)application).addBufferedResponse(sessionId,stripped.substring(index + 1),servletResponse);
      }
    }
 catch (    RuntimeException ex) {
      setResponse(currentResponse);
      Throwable cause=ex;
      while (cause != null) {
        if (cause instanceof AbortException) {
          throw ((AbortException)cause);
        }
        cause=cause.getCause();
      }
      if (!(ex instanceof PageExpiredException)) {
        logRuntimeException(ex);
      }
      IRequestCycleProcessor processor=getProcessor();
      processor.respond(ex,this);
      return;
    }
  }
 else {
    redirectUrl=page.urlFor(IRedirectListener.INTERFACE).toString();
  }
  if (redirectUrl == null) {
    redirectUrl=page.urlFor(IRedirectListener.INTERFACE).toString();
  }
  getSession().touch(page);
  response.redirect(redirectUrl);
}
