{
  final File file=getModelObject();
  if (file == null) {
    throw new IllegalStateException(getClass().getName() + " failed to retrieve a File object from model");
  }
  final String fn=UrlEncoder.QUERY_INSTANCE.encode((fileName != null) ? fileName : file.getName(),getRequest().getCharset());
  IResourceStream resourceStream=new FileResourceStream(new org.apache.wicket.util.file.File(file));
  getRequestCycle().scheduleRequestHandlerAfterCurrent(new ResourceStreamRequestHandler(resourceStream){
    @Override public void respond(    IRequestCycle requestCycle){
      super.respond(requestCycle);
      if (deleteAfter) {
        file.delete();
      }
    }
  }
.setFileName(fn).setContentDisposition(ContentDisposition.ATTACHMENT));
}
