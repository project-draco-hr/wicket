{
  if (dirtyAll) {
    return;
  }
  Object parentNode=e.getTreePath().getLastPathComponent();
  TreeItem parentItem=nodeToItemMap.get(parentNode);
  if (parentItem != null && isNodeVisible(parentNode)) {
    List<?> eventChildren=Arrays.asList(e.getChildren());
    boolean wasLeaf=true;
    int nodeChildCount=getChildCount(parentNode);
    for (int i=0; wasLeaf && i < nodeChildCount; i++) {
      wasLeaf=eventChildren.contains(getChildAt(parentNode,i));
    }
    boolean addingToHiddedRoot=parentItem.getParentItem() == null && isRootLess();
    if (wasLeaf && !addingToHiddedRoot) {
      Object grandparentNode=getParentNode(parentNode);
      boolean addingToHiddedRootSon=grandparentNode != null && getParentNode(grandparentNode) == null && isRootLess();
      if (grandparentNode != null && !addingToHiddedRootSon) {
        invalidateNodeWithChildren(grandparentNode);
      }
 else {
        invalidateNode(parentNode,true);
      }
      getTreeState().expandNode(parentNode);
    }
 else {
      if (isNodeExpanded(parentNode)) {
        List<TreeItem> itemChildren=parentItem.getChildren();
        int childLevel=parentItem.getLevel() + 1;
        final int[] childIndices=e.getChildIndices();
        for (int i=0; i < eventChildren.size(); ++i) {
          TreeItem item=newTreeItem(parentItem,eventChildren.get(i),childLevel);
          itemContainer.add(item);
          if (itemChildren != null) {
            itemChildren.add(childIndices[i],item);
            markTheLastButOneChildDirty(parentItem,item);
          }
          if (!dirtyItems.contains(item)) {
            dirtyItems.add(item);
          }
          if (!dirtyItemsCreateDOM.contains(item) && !item.hasParentWithChildrenMarkedToRecreation()) {
            dirtyItemsCreateDOM.add(item);
          }
        }
      }
    }
  }
}
