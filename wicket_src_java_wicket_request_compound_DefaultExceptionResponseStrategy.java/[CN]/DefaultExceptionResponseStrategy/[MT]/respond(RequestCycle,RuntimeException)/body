{
  final Session session=requestCycle.getSession();
  final Application application=session.getApplication();
  final IExceptionSettings settings=application.getExceptionSettings();
  final Page responsePage=requestCycle.getResponsePage();
  Page override=onRuntimeException(responsePage,e);
  if (override != null) {
    requestCycle.setResponsePage(override);
    requestCycle.setRedirect(true);
  }
 else   if (settings.getUnexpectedExceptionDisplay() != IExceptionSettings.SHOW_NO_EXCEPTION_PAGE) {
    Class internalErrorPageClass=application.getApplicationSettings().getInternalErrorPage();
    Class responseClass=responsePage != null ? responsePage.getClass() : null;
    if (responseClass != internalErrorPageClass && settings.getUnexpectedExceptionDisplay() == IExceptionSettings.SHOW_INTERNAL_ERROR_PAGE) {
      final IPageFactory pageFactory;
      IRequestTarget requestTarget=requestCycle.getRequestTarget();
      if (requestTarget instanceof IPageRequestTarget) {
        pageFactory=session.getPageFactory(((IPageRequestTarget)requestTarget).getPage());
      }
 else {
        pageFactory=session.getPageFactory();
      }
      requestCycle.setResponsePage(pageFactory.newPage(internalErrorPageClass));
    }
 else     if (responseClass != ExceptionErrorPage.class) {
      requestCycle.setResponsePage(new ExceptionErrorPage(e,requestCycle.getResponsePage()));
    }
 else {
      throw new WicketRuntimeException("Internal Error: Could not render error page " + internalErrorPageClass,e);
    }
    requestCycle.setRedirect(true);
  }
}
