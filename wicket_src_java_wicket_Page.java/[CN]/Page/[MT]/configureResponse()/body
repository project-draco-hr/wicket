{
  final Response response=getResponse();
  final Application app=Application.get();
  response.setContentType("text/" + getMarkupType() + "; charset="+ app.getRequestCycleSettings().getResponseRequestEncoding());
  final MarkupStream markupStream=findMarkupStream();
  if ((markupStream != null) && (markupStream.getXmlDeclaration() != null) && (app.getMarkupSettings().getStripXmlDeclarationFromOutput() == false)) {
    response.write("<?xml version='1.0' encoding='" + app.getRequestCycleSettings().getResponseRequestEncoding() + "'?>");
  }
  response.setLocale(getSession().getLocale());
}
