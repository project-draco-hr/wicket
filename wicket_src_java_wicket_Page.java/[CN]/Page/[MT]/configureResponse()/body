{
  final Response response=getResponse();
  final MarkupStream markupStream=findMarkupStream();
  if ((markupStream != null) && (markupStream.getXmlDeclaration() != null)) {
    response.setContentType("text/" + getMarkupType() + "; charset="+ markupStream.getEncoding());
    if (getApplicationSettings().getStripXmlDeclarationFromOutput() == false) {
      response.write(markupStream.getXmlDeclaration());
    }
  }
 else {
    response.setContentType("text/" + getMarkupType());
  }
  response.setLocale(getSession().getLocale());
}
