{
  super(request);
  final boolean isMultipart=ServletFileUpload.isMultipartContent(request);
  if (!isMultipart) {
    throw new IllegalStateException("ServletRequest does not contain multipart content");
  }
  DiskFileItemFactory factory=new DiskFileItemFactory();
  ServletFileUpload upload=new ServletFileUpload(factory);
  String encoding=request.getCharacterEncoding();
  if (encoding != null) {
    upload.setHeaderEncoding(encoding);
  }
  upload.setSizeMax(maxSize.bytes());
  final List items=upload.parseRequest(request);
  for (Iterator i=items.iterator(); i.hasNext(); ) {
    final FileItem item=(FileItem)i.next();
    if (item.isFormField()) {
      final String value;
      if (encoding != null) {
        try {
          value=item.getString(encoding);
        }
 catch (        UnsupportedEncodingException e) {
          throw new WicketRuntimeException(e);
        }
      }
 else {
        value=item.getString();
      }
      parameters.put(item.getFieldName(),value);
    }
 else {
      files.put(item.getFieldName(),item);
    }
  }
}
