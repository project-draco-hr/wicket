{
  MarkupResourceData markupResourceData=markup.getMarkupResourceData();
  xmlParser.parse(markupResourceData.getResource().getInputStream(),markupSettings.getDefaultMarkupEncoding());
  parseMarkup();
  markupResourceData.setEncoding(xmlParser.getEncoding());
  markupResourceData.setXmlDeclaration(xmlParser.getXmlDeclaration());
  if (xmlParser.getXmlDeclaration() == null) {
    if (markupSettings.getThrowExceptionOnMissingXmlDeclaration()) {
      throw new MarkupException(markupResourceData.getResource(),"The markup file does not have a XML declaration prolog. " + ". E.g. <?xml version=\"1.0\" encoding=\"UTF-8\" ?>");
    }
 else {
      log.debug("The markup file does not have a XML declaration prolog: " + markupResourceData.getResource() + ". It is more save to use it. E.g. <?xml version=\"1.0\" encoding=\"UTF-8\" ?>");
    }
  }
  return markup;
}
