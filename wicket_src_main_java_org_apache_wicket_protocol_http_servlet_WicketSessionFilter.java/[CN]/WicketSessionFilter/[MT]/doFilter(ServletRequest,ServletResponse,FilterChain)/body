{
  HttpServletRequest httpServletRequest=((HttpServletRequest)request);
  HttpSession httpSession=httpServletRequest.getSession(false);
  if (httpSession != null) {
    if (sessionKey == null) {
      WebApplication application=(WebApplication)Application.get(filterName);
      if (application == null) {
        throw new IllegalStateException("Could not find wicket application mapped to filter: " + filterName + ". Make sure you set filterName attribute to the name of the wicket filter "+ "for the wicket application whose session you want to access.");
      }
      sessionKey=application.getSessionAttributePrefix(null,filterName) + Session.SESSION_ATTRIBUTE_NAME;
      log.debug("will use {} as the session key to get the Wicket session",sessionKey);
    }
    Session session=(Session)httpSession.getAttribute(sessionKey);
    if (session != null) {
      ThreadContext.setSession(session);
      if (log.isDebugEnabled()) {
        log.debug("session " + session + " set as current for "+ httpServletRequest.getContextPath()+ ","+ httpServletRequest.getServerName());
      }
    }
 else {
      if (log.isDebugEnabled()) {
        log.debug("could not set Wicket session: key " + sessionKey + " not found in http session for "+ httpServletRequest.getContextPath()+ ","+ httpServletRequest.getServerName());
      }
    }
  }
 else {
    log.debug("could not set Wicket session: no http session was created yet for {},{}",httpServletRequest.getContextPath(),httpServletRequest.getServerName());
  }
  try {
    chain.doFilter(request,response);
  }
  finally {
    ThreadContext.detach();
  }
}
