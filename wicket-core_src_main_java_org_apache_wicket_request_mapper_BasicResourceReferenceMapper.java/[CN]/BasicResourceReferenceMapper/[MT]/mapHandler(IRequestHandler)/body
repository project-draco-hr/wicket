{
  if (requestHandler instanceof ResourceReferenceRequestHandler) {
    ResourceReferenceRequestHandler referenceRequestHandler=(ResourceReferenceRequestHandler)requestHandler;
    ResourceReference reference=referenceRequestHandler.getResourceReference();
    Url url;
    if (reference instanceof MetaInfStaticResourceReference) {
      url=((MetaInfStaticResourceReference)reference).mapHandler(referenceRequestHandler);
      if (url != null) {
        return url;
      }
    }
    url=new Url();
    List<String> segments=url.getSegments();
    segments.add(getContext().getNamespace());
    segments.add(getContext().getResourceIdentifier());
    segments.add(getClassName(reference.getScope()));
    PageParameters parameters=referenceRequestHandler.getPageParameters();
    if (parameters == null) {
      parameters=new PageParameters();
    }
 else {
      parameters=new PageParameters(parameters);
      parameters.clearIndexed();
    }
    encodeResourceReferenceAttributes(url,reference);
    StringTokenizer tokens=new StringTokenizer(reference.getName(),"/");
    while (tokens.hasMoreTokens()) {
      String token=tokens.nextToken();
      if (tokens.hasMoreTokens() == false) {
        if (reference instanceof PackageResourceReference) {
          final PackageResourceReference pkgref=(PackageResourceReference)reference;
          final ResourceUrl resourceUrl=new ResourceUrl(token,parameters);
          getCachingStrategy().decorateUrl(resourceUrl,pkgref);
          token=resourceUrl.getFileName();
          if (Strings.isEmpty(token)) {
            log.debug("Caching strategy {} returned an empty name, not mapping {}",getCachingStrategy().getClass().getName(),url);
            return null;
          }
          if (parameters.getIndexedCount() > 0)           throw new IllegalStateException("caching strategy must not add indexed parameters");
        }
      }
      segments.add(token);
    }
    if (parameters.isEmpty() == false) {
      url=encodePageParameters(url,parameters,pageParametersEncoder);
    }
    return url;
  }
  return null;
}
