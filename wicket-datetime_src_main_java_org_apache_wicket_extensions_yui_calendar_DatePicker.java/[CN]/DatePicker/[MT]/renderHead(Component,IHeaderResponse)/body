{
  if (includeYUILibraries()) {
    YuiLib.load(response);
  }
  Map<String,Object> variables=new HashMap<String,Object>();
  String widgetId=getEscapedComponentMarkupId();
  variables.put("componentId",getComponentMarkupId());
  variables.put("widgetId",widgetId);
  variables.put("datePattern",getDatePattern());
  variables.put("fireChangeEvent",notifyComponentOnDateSelected());
  variables.put("alignWithIcon",alignWithIcon());
  variables.put("hideOnSelect",hideOnSelect());
  variables.put("showOnFieldClick",showOnFieldClick());
  variables.put("basePath",Strings.stripJSessionId(RequestCycle.get().urlFor(YUI,null).toString()) + "/");
  variables.put("wicketDatePath",RequestCycle.get().urlFor(WICKET_DATE,null));
  if (Application.get().usesDevelopmentConfig()) {
    variables.put("filter","filter: \"RAW\",");
    variables.put("allowRollup",false);
  }
 else {
    variables.put("filter","");
    variables.put("allowRollup",true);
  }
  String script=getAdditionalJavascript();
  if (script != null) {
    variables.put("additionalJavascript",Strings.replaceAll(script,"${calendar}","YAHOO.wicket." + widgetId + "DpJs"));
  }
  Map<String,Object> p=new HashMap<String,Object>();
  configure(p);
  if (!p.containsKey("navigator") && enableMonthYearSelection()) {
    p.put("navigator",Boolean.TRUE);
  }
  if (enableMonthYearSelection() && p.containsKey("pages") && Objects.longValue(p.get("pages")) > 1) {
    throw new IllegalStateException("You cannot use a CalendarGroup with month/year selection!");
  }
  StringBuilder calendarInit=new StringBuilder();
  for (Iterator<Entry<String,Object>> i=p.entrySet().iterator(); i.hasNext(); ) {
    Entry<String,Object> entry=i.next();
    calendarInit.append(entry.getKey());
    Object value=entry.getValue();
    if (value instanceof CharSequence) {
      calendarInit.append(":\"");
      calendarInit.append(Strings.toEscapedUnicode(value.toString()));
      calendarInit.append("\"");
    }
 else     if (value instanceof CharSequence[]) {
      calendarInit.append(":[");
      CharSequence[] valueArray=(CharSequence[])value;
      for (int j=0; j < valueArray.length; j++) {
        CharSequence tmpValue=valueArray[j];
        if (j > 0) {
          calendarInit.append(",");
        }
        if (tmpValue != null) {
          calendarInit.append("\"");
          calendarInit.append(Strings.toEscapedUnicode(tmpValue.toString()));
          calendarInit.append("\"");
        }
      }
      calendarInit.append("]");
    }
 else     if (value instanceof Map) {
      calendarInit.append(":");
      @SuppressWarnings("unchecked") Map<String,Object> map=(Map<String,Object>)value;
      appendMapping(map,calendarInit);
    }
 else {
      calendarInit.append(":");
      calendarInit.append(Strings.toEscapedUnicode(String.valueOf(value)));
    }
    if (i.hasNext()) {
      calendarInit.append(",");
    }
  }
  variables.put("calendarInit",calendarInit.toString());
  TextTemplate datePickerJs=new PackagedTextTemplate(DatePicker.class,"DatePicker.js");
  datePickerJs.interpolate(variables);
  response.renderOnDomReadyJavascript(datePickerJs.asString());
  if (AjaxRequestTarget.get() != null) {
    final String escapedComponentMarkupId=getEscapedComponentMarkupId();
    final String javascript="var e = Wicket.$('" + escapedComponentMarkupId + "Dp"+ "'); if (e != null && typeof(e.parentNode) != 'undefined' && "+ "typeof(e.parentNode.parentNode != 'undefined')) "+ "e.parentNode.parentNode.removeChild(e.parentNode);"+ "YAHOO.wicket."+ escapedComponentMarkupId+ "DpJs.destroy(); delete YAHOO.wicket."+ escapedComponentMarkupId+ "DpJs;";
    response.renderJavascript(javascript,null);
  }
}
