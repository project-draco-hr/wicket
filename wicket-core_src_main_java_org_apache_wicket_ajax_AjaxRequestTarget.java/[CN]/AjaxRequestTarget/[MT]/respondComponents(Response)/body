{
  for (  Map.Entry<String,Component> stringComponentEntry : markupIdToComponent.entrySet()) {
    final Component component=stringComponentEntry.getValue();
    if (!containsAncestorFor(component)) {
      respondComponent(response,component.getAjaxRegionMarkupId(),component);
    }
  }
  if (header != null) {
    headerRendering=true;
    Response oldResponse=RequestCycle.get().setResponse(encodingHeaderResponse);
    encodingHeaderResponse.reset();
    header.getHeaderResponse().close();
    RequestCycle.get().setResponse(oldResponse);
    writeHeaderContribution(response);
    headerRendering=false;
  }
}
