{
  boolean frozen=page.setFreezePageId(true);
  try {
    final RequestCycle rc=(RequestCycle)requestCycle;
    final WebResponse response=(WebResponse)requestCycle.getResponse();
    if (markupIdToComponent.values().contains(page)) {
      IRequestHandler handler=new RenderPageRequestHandler(new PageProvider(page));
      final String url=rc.urlFor(handler).toString();
      response.sendRedirect(url);
      return;
    }
    for (    ITargetRespondListener listener : respondListeners) {
      listener.onTargetRespond(this);
    }
    final Application app=Application.get();
    page.send(app,Broadcast.BREADTH,this);
    final String encoding=app.getRequestCycleSettings().getResponseRequestEncoding();
    response.setContentType("text/xml; charset=" + encoding);
    response.disableCaching();
    try {
      final StringResponse bodyResponse=new StringResponse();
      contructResponseBody(bodyResponse,encoding);
      invokeResponseFilters(bodyResponse);
      response.write(bodyResponse.getBuffer());
    }
  finally {
      RequestCycle.get().setResponse(response);
    }
  }
  finally {
    page.setFreezePageId(frozen);
  }
}
