{
  ICrypt urlCrypt=Application.get().getSecuritySettings().getCryptFactory().newCrypt();
  if (urlCrypt != null) {
    final int pos=url.toString().indexOf('?');
    if (pos > -1) {
      CharSequence urlPrefix=url.subSequence(0,pos);
      String queryString=url.subSequence(pos + 1,url.length()).toString();
      if (!queryString.startsWith("x=")) {
        queryString=shortenUrl(queryString).toString();
        String encryptedQueryString=urlCrypt.encryptUrlSafe(queryString);
        try {
          encryptedQueryString=URLEncoder.encode(encryptedQueryString,Application.get().getRequestCycleSettings().getResponseRequestEncoding());
        }
 catch (        UnsupportedEncodingException ex) {
          throw new WicketRuntimeException(ex);
        }
        return new AppendingStringBuffer(urlPrefix).append("?x=").append(encryptedQueryString);
      }
    }
  }
  return url;
}
