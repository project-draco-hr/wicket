{
  final List searchStack;
  final String path;
  if (component != null) {
    searchStack=getComponentStack(component);
    path=Strings.replaceAll(component.getPageRelativePath(),":",".").toString();
    if (locale == null) {
      locale=component.getLocale();
    }
    if (style == null) {
      style=component.getStyle();
    }
  }
 else {
    searchStack=null;
    path=null;
    Session session=Session.get();
    if (locale == null) {
      locale=session.getLocale();
    }
    if (style == null) {
      style=session.getStyle();
    }
  }
  String string=visitResourceLoaders(key,path,searchStack,locale,style);
  if (string != null) {
    return substitutePropertyExpressions(component,string,model);
  }
  final IResourceSettings resourceSettings=Application.get().getResourceSettings();
  if (resourceSettings.getUseDefaultOnMissingResource() && (defaultValue != null)) {
    return defaultValue;
  }
  if (resourceSettings.getThrowExceptionOnMissingResource()) {
    AppendingStringBuffer message=new AppendingStringBuffer("Unable to find resource: " + key);
    if (component != null) {
      message.append(" for component: ");
      message.append(component.getPageRelativePath());
      message.append(" [class=").append(component.getClass().getName()).append("]");
    }
    throw new MissingResourceException(message.toString(),(component != null ? component.getClass().getName() : ""),key);
  }
 else {
    return "[Warning: String resource for '" + key + "' not found]";
  }
}
